#include "inttypes.h"
#include "dgt.h"
#include "params.h"
#include "reduce.h"

#if (NEWHOPE_N == 512)
static uint16_t gj[128] = {4075, 5315, 4324, 4916, 10120, 11767, 7210, 9027, 1973, 5574, 11011, 2344, 8775, 1041, 1018, 6364, 3789, 147, 5456, 7840, 7540, 5537, 4789, 4467, 9606, 1190, 8471, 6118, 5445, 3860, 7753, 1050, 7083, 5529, 9090, 12233, 8724, 11635, 10587, 1987, 6427, 6136, 6874, 3643, 400, 1728, 4948, 6137, 10256, 3998, 10367, 8410, 1254, 11316, 5435, 1359, 6950, 5446, 6093, 3710, 11907, 316, 8301, 468, 6415, 677, 6234, 3336, 12237, 9115, 1323, 2766, 12138, 10162, 8332, 9450, 2505, 5906, 10710, 11858, 5241, 9369, 9162, 8120, 787, 8807, 1010, 6821, 2049, 7377, 10968, 192, 3445, 7509, 7591, 7232, 11286, 3532, 12048, 12231, 7280, 1956, 11404, 6008, 8851, 2844, 975, 4212, 5681, 8812, 12147, 11184, 3600, 3263, 7665, 6077, 421, 8209, 6068, 3602, 8076, 11785, 605, 9987, 9260, 5594, 6403, 7507};
static uint16_t invgj[128] = {4075, 6974, 7373, 7965, 3262, 5079, 522, 2169, 5925, 11271, 11248, 3514, 9945, 1278, 6715, 10316, 11239, 4536, 8429, 6844, 6171, 3818, 11099, 2683, 7822, 7500, 6752, 4749, 4449, 6833, 12142, 8500, 11821, 3988, 11973, 382, 8579, 6196, 6843, 5339, 10930, 6854, 973, 11035, 3879, 1922, 8291, 2033, 6152, 7341, 10561, 11889, 8646, 5415, 6153, 5862, 10302, 1702, 654, 3565, 56, 3199, 6760, 5206, 4782, 5886, 6695, 3029, 2302, 11684, 504, 4213, 8687, 6221, 4080, 11868, 6212, 4624, 9026, 8689, 1105, 142, 3477, 6608, 8077, 11314, 9445, 3438, 6281, 885, 10333, 5009, 58, 241, 8757, 1003, 5057, 4698, 4780, 8844, 12097, 1321, 4912, 10240, 5468, 11279, 3482, 11502, 4169, 3127, 2920, 7048, 431, 1579, 6383, 9784, 2839, 3957, 2127, 151, 9523, 10966, 3174, 52, 8953, 6055, 11612, 5874};
#elif (NEWHOPE_N == 1024)
static uint16_t gj[1024] = {296, 296, 8945, 8860, 6691, 3866, 4452, 11171, 9893, 5493, 3949, 10011, 3296, 10313, 11437, 10448, 5659, 5319, 3716, 8318, 2781, 1033, 4775, 8486, 8339, 3725, 694, 1990, 6439, 6139, 6388, 3748, 9900, 953, 4794, 11462, 11862, 5767, 11220, 10092, 4230, 7222, 8528, 9813, 4398, 118, 1386, 2837, 9920, 5374, 186, 7935, 4736, 12159, 3050, 4452, 887, 9893, 7006, 3949, 2247, 3296, 5694, 16, 3461, 11375, 8744, 9046, 4348, 8602, 5561, 4699, 3378, 6536, 5747, 737, 8114, 8591, 2205, 7737, 4610, 1964, 6999, 7103, 4183, 10531, 9321, 8780, 9790, 8436, 5560, 5381, 1899, 7516, 5991, 6375, 320, 2962, 6, 8197, 8874, 6409, 4459, 6634, 7957, 5064, 226, 5625, 2451, 12011, 9876, 11229, 7272, 5252, 10582, 9008, 6881, 1556, 3326, 5133, 3554, 9394, 9437, 3402, 9308, 5357, 8863, 5249, 8303, 8912, 1615, 1396, 4519, 132, 6133, 9281, 1425, 12075, 3483, 7523, 2266, 4972, 3866, 12062, 3429, 8359, 1370, 8375, 10834, 11602, 6344, 7835, 6269, 11727, 10640, 4137, 6640, 10990, 9785, 9181, 7862, 11643, 9825, 6286, 5577, 6510, 8091, 5822, 9392, 8438, 1405, 7378, 1154, 11719, 11915, 11707, 12148, 11741, 535, 5827, 4769, 3544, 2298, 2656, 6978, 8033, 11959, 2378, 3490, 2408, 369, 2480, 5035, 5798, 7391, 1184, 6368, 6098, 1610, 3294, 9413, 5382, 3940, 3634, 2274, 4393, 11765, 7202, 11500, 9484, 4824, 7244, 7076, 10157, 8937, 9110, 7148, 4946, 9658, 10692, 4364, 9814, 6468, 5005, 5330, 4417, 868, 4768, 5716, 10275, 10137, 8283, 43, 10713, 12213, 11645, 10486, 6066, 3204, 7746, 7451, 2986, 11123, 7583, 8235, 7689, 10083, 9119, 6200, 5968, 9333, 11172, 2960, 6972, 9397, 4280, 11593, 1285, 5517, 11161, 12036, 2992, 1669, 9649, 10651, 3342, 11183, 6668, 10952, 6194, 11700, 11240, 1388, 9232, 9550, 1402, 4389, 9006, 10585, 1451, 11318, 7743, 7432, 7749, 5562, 7423, 5957, 3286, 11479, 5839, 2289, 11400, 5956, 92, 11371, 4979, 6357, 2830, 196, 11574, 7237, 11658, 7260, 11386, 9243, 3964, 6241, 996, 1400, 10693, 3102, 2854, 4061, 5939, 5683, 649, 11770, 1329, 11632, 2961, 11417, 4435, 1827, 10452, 10842, 11235, 12120, 930, 8118, 11391, 7372, 444, 2845, 5359, 8726, 11681, 2304, 10154, 2501, 344, 12279, 4927, 5069, 5773, 761, 9701, 4085, 8861, 7816, 5345, 1672, 6942, 2799, 5903, 11343, 1570, 1812, 11698, 5630, 3413, 7117, 9337, 9427, 1788, 6807, 2317, 3587, 3530, 8614, 10334, 11068, 8028, 624, 2238, 8124, 5977, 9043, 4192, 3165, 7452, 11215, 10564, 4027, 7944, 8057, 892, 1764, 5854, 3688, 6610, 8312, 4288, 4448, 828, 4999, 3395, 7832, 7293, 3340, 1108, 11971, 4295, 1991, 5841, 7618, 11961, 7013, 8964, 311, 10214, 9453, 11098, 8394, 8127, 9242, 770, 3550, 8242, 5443, 8296, 902, 5362, 12216, 329, 2634, 7320, 203, 9354, 5301, 9441, 497, 2137, 10012, 2350, 6025, 11565, 1450, 10636, 2335, 10856, 256, 6590, 9836, 5500, 9557, 11471, 1514, 6139, 2608, 10299, 11109, 3803, 12107, 8564, 3775, 1841, 4019, 6970, 613, 3971, 9530, 11256, 11671, 4637, 7653, 861, 3907, 5623, 2623, 9053, 1300, 10807, 5616, 7853, 3792, 6983, 4584, 5097, 8754, 2801, 6849, 1286, 12187, 6015, 8899, 11238, 10220, 3096, 12199, 7476, 8447, 5363, 7489, 5472, 4154, 8045, 11555, 2803, 4441, 3048, 5913, 10218, 4903, 3996, 1027, 11364, 11617, 4207, 1521, 3919, 11136, 8989, 2884, 10322, 4048, 8335, 2249, 1598, 1630, 10879, 2126, 3740, 9103, 10823, 6882, 6939, 2370, 4886, 2865, 462, 3510, 6614, 5332, 62, 3247, 7897, 9603, 5113, 9320, 11540, 8311, 10528, 671, 9296, 9289, 9682, 3016, 8323, 12046, 8428, 8889, 1961, 9890, 115, 7098, 10371, 3136, 2037, 11869, 9712, 5559, 10496, 2178, 10028, 1544, 10878, 8758, 1245, 476, 10294, 8304, 4955, 4905, 4201, 1663, 7307, 1777, 5022, 10863, 555, 4654, 9771, 5291, 776, 9585, 4827, 3636, 8616, 7351, 11660, 3, 4144, 4437, 9054, 160, 8004, 3149, 3609, 113, 430, 7370, 9231, 10123, 6548, 3915, 760, 4372, 1194, 2174, 8599, 7875, 2235, 9442, 12113, 9018, 8107, 4057, 8478, 1689, 10451, 3364, 9756, 9644, 4399, 8236, 5240, 2305, 9315, 5042, 916, 2780, 10035, 7094, 8942, 4895, 6773, 1484, 1732, 6267, 5360, 2987, 1035, 2437, 7316, 3646, 6044, 2566, 1173, 10102, 2118, 9867, 1115, 6250, 2359, 5088, 11205, 4284, 6623, 1002, 7728, 7278, 942, 7313, 4229, 1607, 11879, 875, 8441, 3780, 10904, 4645, 9628, 404, 9150, 10146, 5548, 1065, 8729, 7012, 10370, 11121, 558, 1207, 4158, 3248, 5182, 11854, 1281, 7952, 2093, 1378, 6875, 10377, 5122, 8193, 11384, 493, 1006, 6845, 9082, 9908, 401, 7428, 11518, 11935, 2568, 2912, 8036, 5698, 1781, 9430, 7826, 11244, 10705, 7277, 3657, 9808, 1543, 442, 4292, 2401, 6744, 7188, 11801, 1067, 3299, 8456, 10101, 8511, 8244, 390, 10293, 11516, 9565, 1017, 3870, 4885, 9345, 5084, 9776, 10657, 6840, 1440, 10591, 3763, 7903, 3066, 7752, 12262, 11860, 11744, 4995, 5019, 1916, 3704, 8331, 9611, 7971, 8146, 3810, 4714, 6628, 242, 6576, 1537, 5305, 12280, 12146, 11267, 9705, 11809, 566, 2842, 1462, 11950, 10999, 2468, 9174, 6498, 4934, 544, 10009, 8705, 9961, 8112, 10097, 1381, 11019, 2525, 1887, 4278, 10624, 10616, 7554, 6958, 9512, 4989, 9632, 7935, 11381, 12159, 8858, 5374, 8922, 9452, 9541, 3949, 6762, 3296, 10041, 9893, 4259, 7837, 7093, 9813, 257, 118, 11433, 7222, 5514, 2197, 7599, 953, 5584, 8541, 528, 5767, 11070, 827, 3582, 1260, 7731, 7901, 5379, 5755, 6783, 7657, 4233, 10593, 8554, 10861, 5985, 11955, 9713, 9863, 11975, 10200, 6406, 7197, 11944, 3284, 5754, 2881, 6178, 3241, 11898, 729, 11583, 9000, 7821, 2013, 3310, 7399, 4230, 5911, 1069, 9558, 4398, 3932, 3761, 145, 11862, 5542, 7495, 3637, 5901, 8830, 2389, 2548, 887, 8058, 9239, 8907, 2247, 11934, 5283, 1759, 4736, 8582, 12103, 3694, 10903, 7110, 2369, 10963, 11702, 5086, 4346, 3014, 1464, 9088, 2392, 11499, 6564, 11334, 12135, 11119, 5988, 2319, 8172, 8577, 1100, 3135, 4752, 2747, 1318, 7443, 7660, 3553, 470, 7484, 6946, 1062, 4585, 9995, 9976, 1635, 9593, 9521, 6541, 1177, 11874, 8034, 665, 140, 859, 10436, 4694, 11563, 4850, 7678, 8663, 7969, 5094, 1000, 869, 3091, 1322, 81, 1287, 9326, 7539, 4896, 4058, 9923, 8832, 3051, 11610, 1305, 8446, 722, 6010, 8155, 3953, 5736, 9212, 12288, 2715, 10810, 9271, 4043, 9621, 7143, 11086, 3542, 5757, 3504, 10615, 8668, 12104, 2545, 9032, 6429, 7934, 9094, 10680, 11077, 9417, 1646, 4306, 4591, 8770, 6561, 5935, 7266, 8944, 5828, 5212, 4978, 2630, 1351, 6446, 3328, 9184, 6512, 3791, 2639, 11891, 7468, 1230, 9664, 11544, 949, 4155, 9283, 1394, 2744, 9463, 11726, 4709, 2975, 9037};
static uint16_t invgj[1024] = {2566, 11116, 2187, 2118, 6039, 2359, 2422, 1115, 6267, 6929, 9302, 1035, 8643, 6044, 9852, 7316, 5088, 1084, 8005, 6623, 5011, 942, 11287, 7728, 8509, 10904, 11414, 8441, 10682, 11879, 4976, 4229, 11854, 11008, 4337, 2093, 1912, 5122, 10911, 6875, 2381, 401, 5444, 9082, 11796, 1006, 4096, 11384, 4645, 2661, 11885, 9150, 11224, 8729, 2143, 5548, 9041, 5182, 11082, 4158, 1168, 558, 5277, 10370, 11744, 7294, 7270, 1916, 2678, 7971, 8585, 8331, 10752, 5305, 12047, 6576, 7575, 6628, 4143, 3810, 1017, 8419, 7404, 9345, 1632, 6840, 7205, 9776, 27, 11860, 9223, 7752, 8526, 7903, 10849, 10591, 442, 7997, 9888, 6744, 11222, 3299, 5101, 11801, 773, 9565, 11899, 10293, 3778, 8244, 3833, 10101, 7428, 771, 354, 2568, 6591, 1781, 9377, 8036, 2481, 1543, 5012, 3657, 1045, 10705, 2859, 7826, 1630, 1410, 10163, 3740, 5407, 6939, 3186, 10823, 11136, 3300, 9405, 10322, 10040, 1598, 8241, 8335, 2370, 7403, 9424, 462, 6957, 62, 8779, 6614, 3978, 10528, 2969, 11540, 2686, 5113, 9042, 7897, 11869, 2577, 6730, 10496, 10745, 10878, 10111, 10028, 7384, 4201, 3985, 4955, 11813, 10294, 3531, 1245, 671, 2993, 3000, 9682, 243, 8428, 9273, 8323, 9153, 2037, 5191, 10371, 2399, 115, 3400, 1961, 9644, 7890, 4053, 5240, 7247, 916, 9984, 9315, 10805, 1732, 7394, 6773, 5195, 8942, 9509, 10035, 4372, 11095, 10115, 8599, 2847, 12113, 4414, 2235, 8925, 9756, 10600, 10451, 8232, 8478, 3271, 8107, 3, 8145, 7852, 9054, 9140, 3609, 12129, 8004, 8374, 760, 2166, 6548, 4919, 9231, 12176, 430, 1663, 4982, 10512, 5022, 7635, 9771, 1426, 555, 4938, 11660, 8653, 8616, 2704, 4827, 6998, 776, 11950, 1290, 9821, 9174, 11745, 10009, 5791, 4934, 12280, 143, 1022, 9705, 9447, 1462, 480, 566, 8705, 2328, 4177, 10097, 9764, 1887, 10908, 11019, 7300, 9632, 5331, 9512, 1673, 7554, 8011, 10624, 9813, 12032, 12171, 11433, 10092, 7599, 5067, 5514, 11462, 3582, 6522, 11070, 3748, 528, 11336, 5584, 7935, 908, 130, 8858, 2837, 9541, 6915, 8922, 4452, 7093, 2396, 4259, 8993, 10041, 8340, 6762, 2548, 11402, 4231, 9239, 355, 5283, 3382, 2247, 5179, 2369, 8595, 10903, 3707, 12103, 10530, 4736, 7399, 8059, 6378, 1069, 8357, 3761, 2731, 4398, 3459, 2389, 8652, 5901, 6747, 7495, 12144, 11862, 10200, 5883, 5092, 11944, 9408, 6178, 9005, 5754, 10276, 3310, 3289, 7821, 11560, 11583, 9048, 11898, 1260, 4558, 4388, 5379, 4632, 4233, 6534, 6783, 2426, 11975, 334, 9713, 1428, 5985, 1696, 8554, 2639, 398, 4821, 1230, 11340, 4155, 2625, 11544, 9314, 9037, 563, 4709, 9545, 9463, 3006, 1394, 4591, 3519, 5728, 5935, 6461, 5212, 5023, 8944, 5777, 3791, 8961, 9184, 10938, 6446, 7311, 2630, 3542, 6532, 8785, 10615, 9744, 9032, 3621, 12104, 10643, 4306, 1212, 9417, 3195, 10680, 5860, 7934, 1305, 3843, 11567, 6010, 6553, 9212, 4134, 3953, 5146, 11086, 8246, 9621, 1479, 9271, 1, 2715, 7969, 7195, 11289, 869, 12208, 1287, 9198, 1322, 9238, 11610, 2366, 8832, 7393, 4058, 2963, 7539, 1635, 2696, 2768, 6541, 4255, 665, 11112, 11874, 4611, 8663, 726, 4850, 1853, 4694, 12149, 859, 8577, 11189, 9154, 4752, 4846, 7660, 9542, 1318, 2294, 9976, 11227, 4585, 4805, 6946, 8736, 470, 10963, 587, 7203, 4346, 3201, 2392, 9275, 1464, 9970, 8172, 1170, 5988, 955, 12135, 790, 6564, 1827, 1837, 1447, 11235, 11632, 9328, 872, 4435, 12120, 11359, 4171, 11391, 9444, 5359, 4917, 444, 5069, 6516, 11528, 9701, 4473, 5345, 8204, 8861, 8726, 608, 9985, 10154, 10, 4927, 9788, 344, 8124, 6312, 3246, 4192, 1074, 10564, 9124, 7452, 3587, 8759, 3675, 10334, 11665, 2238, 1221, 8028, 5630, 8876, 5172, 9337, 5482, 2317, 2862, 1788, 1672, 5347, 9490, 5903, 10477, 11698, 946, 1570, 5517, 1128, 253, 2992, 9397, 8009, 696, 1285, 1669, 2640, 1638, 3342, 1337, 6194, 1106, 6668, 10585, 10838, 971, 7743, 6727, 7423, 4857, 7749, 11700, 1049, 10901, 9232, 7900, 9006, 2739, 1402, 3102, 9435, 8228, 5939, 519, 1329, 6606, 649, 7260, 903, 3046, 3964, 10889, 10693, 6048, 996, 11371, 7310, 5932, 2830, 5052, 11658, 12093, 11574, 5957, 9003, 810, 5839, 6333, 92, 10000, 11400, 1764, 6435, 8601, 6610, 4027, 4345, 4232, 892, 8312, 8001, 7841, 828, 4457, 7293, 7290, 3395, 7013, 3325, 11978, 10214, 3895, 8127, 2836, 11098, 3340, 11181, 318, 4295, 4671, 11961, 10298, 5841, 2335, 1433, 12033, 6590, 2732, 11471, 2453, 5500, 497, 10152, 2277, 2350, 10839, 10636, 6264, 11565, 12216, 11960, 9655, 7320, 6988, 9441, 12086, 9354, 9242, 11519, 8739, 8242, 11387, 5362, 6846, 8296, 4903, 8293, 11262, 11364, 10768, 3919, 672, 4207, 4154, 4244, 734, 2803, 6376, 10218, 7848, 3048, 10220, 9193, 90, 7476, 4800, 5472, 3842, 5363, 8754, 9488, 5440, 1286, 3390, 11238, 102, 6015, 1300, 1482, 6673, 7853, 7705, 5097, 8497, 6983, 11671, 7652, 4636, 861, 9666, 9053, 8382, 5623, 3775, 10448, 8270, 6970, 2759, 11256, 11676, 3971, 1514, 6150, 9681, 10299, 182, 8564, 1180, 3803, 7862, 646, 9785, 3108, 9825, 6003, 6712, 6510, 1405, 4911, 11135, 11719, 8091, 6467, 2897, 8438, 11959, 9911, 8799, 2408, 2298, 9633, 5311, 8033, 535, 6462, 7520, 3544, 11915, 582, 141, 11741, 8303, 3377, 8863, 7040, 1615, 10893, 7770, 132, 3483, 4766, 10023, 4972, 6133, 3008, 10864, 12075, 10640, 8152, 5649, 10990, 6344, 4454, 6020, 11727, 1370, 3914, 1455, 11602, 3866, 227, 8860, 8359, 5035, 6491, 369, 9809, 7391, 11105, 5921, 6098, 3940, 8655, 10015, 4393, 1610, 8995, 2876, 5382, 9658, 1597, 7925, 9814, 8937, 3179, 5141, 4946, 4824, 5045, 5213, 10157, 11765, 5087, 789, 9484, 9333, 1117, 9329, 6972, 10083, 3170, 6089, 5968, 11123, 4706, 4054, 7689, 3204, 4543, 4838, 2986, 12213, 644, 1803, 6066, 10137, 4006, 12246, 10713, 868, 7521, 6573, 10275, 6468, 7284, 6959, 4417, 10084, 7737, 4610, 10325, 4183, 1758, 6999, 5186, 1899, 4773, 5560, 6908, 9790, 3853, 9321, 3509, 6595, 16, 3461, 914, 4348, 3687, 8744, 3243, 8114, 3698, 5747, 11552, 3378, 5753, 5561, 7590, 6298, 6375, 320, 9327, 8874, 5880, 6, 4092, 2451, 278, 226, 6664, 7957, 7225, 4459, 5655, 9308, 6932, 9437, 8887, 3554, 2895, 3326, 7156, 6881, 10733, 10582, 3281, 7272, 7037, 9876, 1060, 11220, 2197, 8059, 7222, 7891, 118, 3761, 9813, 6388, 8541, 2389, 953, 427, 5767, 7495, 11462, 1386, 9452, 2369, 5374, 7553, 12159, 12103, 7935, 10042, 3296, 5283, 3949, 11402, 9893, 9239, 4452, 3716, 3971, 9508, 1033, 11437, 1841, 6630, 5319, 4775, 3803, 3950, 3725, 5850, 6139, 11595, 1990, 9893, 6796, 4452, 1118, 3949, 2278, 8993, 10313, 3344, 8860, 6691, 8423, 296, 11993};
#else
#error "NEWHOPE_N must be either 512 or 1024"
#endif

#if (NEWHOPE_N == 512)

void dgt(uint16_t *x)
{
  int m, distance;
  int j1, j2, j, k;
  uint16_t a, temp_re, temp_img;
  
  distance = 256;
  for(m = 1; m < 256; m <<= 1)
  {
    // Even level
    for(k = 0; k < m; ++k)
    {
      j1 = k*distance << 1;
      j2 = j1+distance-1;

      a = gj[k];
      for(j = j1; j <= j2; j = j+2)
      {
        temp_re =  montgomery_reduce((uint32_t)a*x[j+distance]);
        temp_img = montgomery_reduce((uint32_t)a*x[j+distance+1]);

        x[j+distance] = x[j]+3*NEWHOPE_Q-temp_re;
        x[j+distance+1] = x[j+1]+3*NEWHOPE_Q-temp_img;
        
        x[j] = x[j]+temp_re;
        x[j+1] = x[j+1]+temp_img;
      }
    }
    distance >>= 1;
    m <<= 1;
    // Odd level
    for(k = 0; k < m; ++k)
    {
      j1 = k*distance << 1;
      j2 = j1+distance-1;

      a = gj[k];
      for(j = j1; j <= j2; j = j+2)
      {
        temp_re =  montgomery_reduce((uint32_t)a*x[j+distance]);
        temp_img = montgomery_reduce((uint32_t)a*x[j+distance+1]);
        
        // NewHope forward NTT adopts the Gentleman-Sande butterflies, which support laziness after subtractions in all levels, differently of the Cooley-Tukey butterfly
        x[j+distance] = (x[j]+3*NEWHOPE_Q-temp_re) % NEWHOPE_Q;         
        x[j+distance+1] = (x[j+1]+3*NEWHOPE_Q-temp_img) % NEWHOPE_Q;
        
        x[j] = (x[j]+temp_re) % NEWHOPE_Q;
        x[j+1] = (x[j+1]+temp_img) % NEWHOPE_Q;
      }
    }
    distance >>= 1;
  }  
}

void idgt(uint16_t *poly)
{
  int distance, j1, jtwiddle, j;
  uint16_t sub_re, sub_img;

  for(distance = 2; distance < NEWHOPE_N; distance <<= 1)
  {
    // Even level
    for(j1 = 0; j1 < distance; j1 += 2)
    {
      jtwiddle = 0;
      for(j = j1; j < NEWHOPE_N; j += distance << 1)
      {
        sub_re = poly[j]+3*NEWHOPE_Q-poly[j+distance]; // Omit reduction (be lazy)
        sub_img = poly[j+1]+3*NEWHOPE_Q-poly[j+distance+1]; // Omit reduction (be lazy)

        poly[j] = poly[j]+poly[j+distance]; // Omit reduction (be lazy)
        poly[j+1] = poly[j+1]+poly[j+distance+1]; // Omit reduction (be lazy)

        poly[j+distance] = montgomery_reduce((uint32_t)invgj[jtwiddle]*sub_re);
        poly[j+distance+1] = montgomery_reduce((uint32_t)invgj[jtwiddle++]*sub_img);
      }
    }
    distance <<= 1;
    // Odd level
    for(j1 = 0; j1 < distance; j1 += 2)
    {
      jtwiddle = 0;
      for(j = j1; j < NEWHOPE_N; j += distance << 1)
      {
        sub_re = poly[j]+3*NEWHOPE_Q-poly[j+distance]; // Omit reduction (be lazy)
        sub_img = poly[j+1]+3*NEWHOPE_Q-poly[j+distance+1]; // Omit reduction (be lazy)

        poly[j] = (poly[j]+poly[j+distance]) % NEWHOPE_Q;
        poly[j+1] = (poly[j+1]+poly[j+distance+1]) % NEWHOPE_Q;

        poly[j+distance] = montgomery_reduce((uint32_t)invgj[jtwiddle]*sub_re);
        poly[j+distance+1] = montgomery_reduce((uint32_t)invgj[jtwiddle++]*sub_img);
      }
    }    
  }
}

#elif (NEWHOPE_N == 1024)

void dgt(uint16_t *x)
{
  int m, distance, jtwiddle;
  int j1, j2, j, k;
  uint16_t temp_re, temp_img;
  uint16_t a, b, c, d;

  jtwiddle = 0;
  distance = 512;
  for(m = 1; m < 256; m <<= 1)
  {
    // Even level
    for(k = 0; k < m; ++k)
    {
      j1 = (k*distance) << 1;
      j2 = j1+distance-1;
      for(j = j1; j <= j2; j = j+2)
      {
        a = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance]);
        b = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance+1]);
        c = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance+1]);
        d = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance]);

        temp_re = (a + (3*NEWHOPE_Q - b)) % NEWHOPE_Q;
        temp_img = (c + d) % NEWHOPE_Q;

        x[j+distance] = x[j] + (3*NEWHOPE_Q - temp_re); // Omit reduction (be lazy)
        x[j+distance+1] = x[j+1] + (3*NEWHOPE_Q - temp_img); // Omit reduction (be lazy)

        x[j] = x[j] + temp_re; // Omit reduction (be lazy)
        x[j+1] = x[j+1] + temp_img; // Omit reduction (be lazy)
      }
      jtwiddle += 2;
    }
    distance >>= 1;
    m <<= 1;
    // Odd level
    for(k = 0; k < m; ++k)
    {
      j1 = (k*distance) << 1;
      j2 = j1+distance-1;
      for(j = j1; j <= j2; j = j+2)
      {
        a = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance]);
        b = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance+1]);
        c = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance+1]);
        d = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance]);

        temp_re = (a + (3*NEWHOPE_Q - b)) % NEWHOPE_Q;
        temp_img = (c + d) % NEWHOPE_Q;

        x[j+distance] = (x[j] + (3*NEWHOPE_Q - temp_re)) % NEWHOPE_Q;
        x[j+distance+1] = (x[j+1] + (3*NEWHOPE_Q - temp_img)) % NEWHOPE_Q;

        x[j] = (x[j] + temp_re) % NEWHOPE_Q;
        x[j+1] = (x[j+1] + temp_img) % NEWHOPE_Q;
      }
      jtwiddle += 2;
    }
    distance >>= 1;    
  }
  // Even level
  for(k = 0; k < m; ++k)
  {
    j1 = (k*distance) << 1;
    j2 = j1+distance-1;
    for(j = j1; j <= j2; j = j+2)
    {
      a = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance]);
      b = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance+1]);
      c = montgomery_reduce((uint32_t)gj[jtwiddle]*x[j+distance+1]);
      d = montgomery_reduce((uint32_t)gj[jtwiddle+1]*x[j+distance]);

      temp_re = (a + (3*NEWHOPE_Q - b)) % NEWHOPE_Q;
      temp_img = (c + d) % NEWHOPE_Q;

      x[j+distance] = x[j] + (3*NEWHOPE_Q - temp_re); // Omit reduction (be lazy)
      x[j+distance+1] = x[j+1] + (3*NEWHOPE_Q - temp_img); // Omit reduction (be lazy)

      x[j] = x[j] + temp_re; // Omit reduction (be lazy)
      x[j+1] = x[j+1] + temp_img; // Omit reduction (be lazy)
    }
    jtwiddle += 2;
  }  
}

void idgt(uint16_t *x)
{
  int distance, j1, jtwiddle, m, j, h;
  uint16_t temp_re, temp_img, sum_re, sum_img;

  h = 0;
  distance = 2;
  for(m = 512; m > 1; m >>= 1)
  {
    for(j1 = 0; j1 < distance; j1+=2)
    {
      jtwiddle = h;
      for(j = j1; j < NEWHOPE_N; j+=2*distance)
      {
        temp_re = x[j];
        temp_img = x[j+1];

        x[j] = (x[j] + x[j+distance]) % NEWHOPE_Q;
        x[j+1] = (x[j+1] + x[j+distance+1]) % NEWHOPE_Q;

        sum_re = temp_re + 3*NEWHOPE_Q - x[j+distance];
        sum_img = temp_img + 3*NEWHOPE_Q - x[j+distance+1];

        x[j+distance] = montgomery_reduce((uint32_t)invgj[jtwiddle]*sum_re) + 3*NEWHOPE_Q - 
                        montgomery_reduce((uint32_t)invgj[jtwiddle+1]*sum_img);
        x[j+distance+1] = montgomery_reduce((uint32_t)invgj[jtwiddle]*sum_img) + 
                          montgomery_reduce((uint32_t)invgj[jtwiddle+1]*sum_re);

        jtwiddle += 2;
      }
    }
    h += m;
    distance <<= 1;    
  }

  for(j = 0; j < NEWHOPE_N; ++j)
    x[j] = montgomery_reduce((uint32_t)x[j]*512);
}

#else
#error "NEWHOPE_N must be either 512 or 1024"
#endif
