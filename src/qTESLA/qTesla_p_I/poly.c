/*************************************************************************************
* qTESLA: an efficient post-quantum signature scheme based on the R-LWE problem
*
* Abstract: DGT, modular reduction and polynomial functions
**************************************************************************************/

#include "poly.h"
#include "sha3/fips202.h"
#include "api.h"
#include <inttypes.h>

static uint32_t gj[PARAM_N] = {64939542, 64939542, 289567177, 29520420, 35491863, 318525845, 252802541, 91855681, 136205550, 69950446, 159824855, 70109818, 3291719, 146966120, 150514476, 96547964, 173506014, 174857663, 320942358, 68993125, 260318799, 234867539, 170490781, 16085542, 318042094, 342599734, 254508159, 176237985, 99111779, 57434890, 232467772, 18041912, 176271658, 67061965, 200132340, 173674013, 915757, 144198280, 283688776, 309570728, 271991249, 308593929, 295443201, 35313167, 286432498, 27000301, 192626088, 241285659, 111488825, 166610280, 340000613, 332577083, 286580052, 30506037, 131174921, 83977365, 260103755, 243801968, 245056013, 289961923, 63514813, 21866946, 228038041, 252547736, 190816460, 89046591, 211628612, 317429505, 85260511, 282237554, 161995618, 325890756, 286076988, 181041403, 49055899, 25051422, 211128270, 36181075, 43469370, 170581572, 317316584, 255847428, 110462126, 238775901, 2154785, 19843747, 108743791, 247588627, 118154301, 112233406, 15109487, 41772654, 194698474, 340755044, 311255526, 232240022, 339408150, 208530917, 101173093, 253734832, 293775346, 279914664, 257324965, 1302564, 316836115, 279744541, 132815464, 76373990, 219744013, 136353816, 74473558, 89526458, 294591060, 124795282, 247567576, 339512484, 334761703, 98368947, 140077325, 61414236, 316900102, 229342753, 147890875, 338707806, 120358256, 232974357, 223869331, 238335278, 58576130, 340007619, 303596885, 340380116, 86861405, 43652962, 336219774, 22295757, 161488570, 226911314, 234236418, 115539643, 65421152, 36472172, 1174474, 225915738, 258242438, 246357903, 323543560, 256311442, 84797824, 250415626, 87811251, 129551299, 41938716, 72923396, 142075486, 32339517, 158462190, 23083138, 177321963, 246056504, 34653403, 138578809, 84895562, 98454809, 326150524, 305087264, 250369813, 13596833, 205205804, 172460425, 15379011, 37083864, 82689827, 282014613, 206110779, 263670486, 207261587, 88152537, 717096, 36766032, 80560710, 37246340, 77916401, 133259182, 199361003, 66389251, 29879476, 42807766, 279060685, 209758099, 79652769, 225423237, 100586081, 100592645, 153705255, 55959415, 60065894, 152948377, 199344349, 127618120, 189546364, 47003138, 83496210, 145056021, 312127830, 176557714, 271769719, 136044101, 187045081, 13649728, 197323761, 247882308, 158880221, 51668226, 49724134, 194284735, 200949585, 61652510, 229213742, 2369490, 65043311, 301491566, 239137939, 168924569, 233235881, 142296133, 188814592, 56354302, 235702635, 13710598, 266295518, 124073380, 58016186, 142034611, 213845287, 107321193, 183839266, 213352941, 247066743, 157821903, 133463476, 182703022, 300653357, 61146723, 25159671, 223831137, 134483391, 220161182, 309282388, 97398139, 230279436, 190855958, 109753283, 257807803, 11077429, 102280532, 256238960, 226090080, 193713085, 256917885, 264741552, 236296264, 130468575, 94455759, 303231602, 157444748, 184989809, 303925075, 164433893, 322070573, 147203380, 1531480, 153751357, 268699565, 199214099, 341915426, 177069739, 299530282, 56865655, 58979299, 221951638, 204818383, 189831391, 215503568, 139551299, 160346132, 224489204, 66333293, 258747514, 257713668, 236464979, 86978974, 204046369, 325905031, 132542968, 16512596, 113847492, 78179034, 48080004, 315038284, 278884449, 231565756, 304608022, 259797397, 334403740, 148104508, 324463291, 262688005, 306438538, 87353876, 51297293, 160013839, 57854565, 119653408, 135351157, 132328521, 310632999, 122651443, 159876547, 294760797, 93972567, 316686257, 261744681, 293081123, 342547978, 260644079, 314600059, 243485818, 206404387, 190407354, 15224790, 266516977, 50441440, 301136650, 34226955, 10452203, 212453426, 36760317, 218851341, 326161710, 13804152, 257114696, 169663339, 260177771, 322532480, 269610292, 141832994, 33024409, 63353219, 305649849, 343136848, 227718820, 283979428, 313561856, 185432604, 78929909, 14617725, 213353303, 325413312, 290160137, 232906613, 102842695, 188977926, 97199228, 29771154, 217458449, 133594616, 280614798, 127536480, 185923524, 93015743, 239691382, 323515081, 160623722, 236032622, 28321279, 280343863, 287740976, 235487512, 81070113, 137122942, 263390914, 201356546, 181662736, 27177310, 167218946, 305757661, 129986654, 26762084, 30545336, 15137714, 21521721, 41440989, 59783243, 105690828, 159671104, 302168464, 239486946, 181550762, 335016012, 196719792, 58710080, 252204009, 259204440, 39964369, 297385260, 109867088, 167369833, 24290918, 291442353, 318124877, 294864162, 88361997, 156777652, 7753244, 249079456, 252046638, 125456554, 296456954, 189152222, 126022154, 138790778, 161328340, 144250570, 342838992, 151830454, 50211760, 213420941, 142805691, 155720900, 111203778, 246307069, 85727166, 139829155, 219236182, 217101561, 81332709, 167348101, 317808559, 158871763, 256558207, 268760898, 113932790, 247859207, 327355074, 324118810, 266987239, 106795166, 90314037, 321564074, 13731160, 32475051, 142133217, 225989245, 149894637, 253280727, 23456543, 66606104, 243566477, 136521473, 309252002, 259851734, 156101136, 110194417, 250329289, 273595915, 50934345, 266782762, 99584735, 245153333, 308865761, 44486585, 292832558, 26006120, 288454324, 8544718, 145523163, 74630691, 182855413, 29364366, 6142389, 201361779, 239763115, 143625378, 277953894, 326050301, 319013614, 260499221, 274720457, 310293772, 343273701, 302001568, 218283561, 225196090, 117051387, 47969593, 313832525, 136746726, 12350470, 211858578, 213649065, 308422995, 60230137, 77295331, 183586, 144485007, 310846214, 323937485, 222384416, 225077240, 32427128, 289566549, 184139445, 39388443, 92591401, 180184975, 240662250, 339895260, 193696235, 162892249, 122003909, 165225660, 166145447, 285131401, 323195686, 223224272, 307120963, 176685332, 130974307, 150734566, 80201773, 236803717, 42386471, 63057095, 273426176, 214975506, 41377866, 27331164, 133651276, 43903345, 266174044, 261617214, 114969113, 296930296, 31280402, 29580462, 25336677, 283099602, 3824834, 106744133, 45098016, 276102835, 129747726, 218310121, 312196526, 96117749, 275893129, 316646483, 184322912, 280422720, 247280905, 318539830, 109882478, 337867102, 217666820, 129362506, 51085872, 327166891, 61013272, 233050090, 58064867, 50872171, 226035340, 340925099, 96516373, 316864540, 320538895, 144039014, 110693914, 254992215, 203070294, 275392252, 341681938, 123401430, 341131739, 223408413, 275758487, 280630256, 335021598, 135966675, 6457077, 165710878, 136130225, 89336972, 62760318, 61999846, 271894979, 31547673, 49965767, 275017072, 110998864, 186515503, 295168459, 210007756, 163834433, 14409363, 314514167, 302835287, 144101415, 308684897, 237992584, 7679073, 328283612, 340233203, 169355709, 323436926, 141389775, 225598796, 149020345, 178397376, 163263848, 310114773, 186190822, 165643927, 4155840, 331868388, 169382436, 248834966, 242538622, 55874979, 260065843, 268875464, 185029656, 75658079, 242676645, 139337501, 74978092, 300767337, 324329002, 274904243, 332153194, 319798769, 99454477, 297985712, 46057960, 19889970, 11816901, 8430020, 278932567, 272031886, 104774775, 64454120, 86155713, 95843051, 304329871, 144719666, 46944855, 263370135, 10076371, 61177396, 123418251, 99164562, 64562424, 155925770, 294821889, 180774530, 105315622, 320475512, 240508762, 110746197, 62526795, 63075164, 191163995, 318540423, 39317327, 340761354, 169197199, 24117924, 25821051, 214379310, 123422552, 262360661, 162956215, 338298258, 140358520, 253094865, 96683783, 122620980, 343169630, 39179546, 329046936, 38973391, 144410955, 145484013, 68079702, 254232996, 278272924, 154196779, 168066197, 36514570, 266482556, 199125431, 272347715, 21557770, 244389586, 240959763, 174681614, 46950650, 332710318, 22985680, 280278667, 39223209, 299795098, 146992532, 231492134, 149611449, 248998375, 202739742, 241137207, 28969942, 302086601, 103569476, 177825782, 3526636, 90497882, 258021677, 91820463, 109063336, 113398296, 28412741, 96760912, 225881840, 149093995, 93414307, 246272342, 294073374, 250258822, 52012142, 228454857, 192744820, 11803800, 201996863, 240816950, 10477975, 170842198, 235746901, 62710400, 46610650, 128627582, 82081523, 94783396, 275718612, 315114864, 111932858, 135925245, 142711216, 245603797, 260244929, 260257019, 65178399, 198066724, 63995115, 118023615, 53269616, 4034460, 88183876, 72651827, 72614779, 49855698, 225019453, 149492703, 193274358, 132014043, 65435712, 294105210, 233518338, 75504843, 50052329, 190993617, 175216519, 329355991, 195674087, 211659615, 298406441, 83284363, 324303657, 121951980, 289694837, 124133208, 271935433, 257560375, 288361849, 258932366, 231296935, 283495743, 170000837, 158868715, 313975083, 207106178, 270863055, 213254397, 79093301, 139065820, 273140786, 294856469, 289033560, 180840394, 44135208, 131311588, 37520514, 330044367, 105888842, 174998282, 27678270, 51445280, 247755013, 14987270, 60247524, 235315075, 166075088, 272609840, 129500233, 142995698, 88955326, 68556018, 283090935, 24042189, 69225428, 190429829, 174358075, 78063053, 99506849, 300456965, 108447337, 94464854, 316149201, 337358261, 157619087, 218511525, 24160836, 303727221, 327421373, 213403511, 313625303, 47219411, 63573478, 284218218, 296758271, 74750950, 24642697, 330792053, 307897724, 321796979, 202412557, 93397075, 8727606, 220238135, 117208829, 90545106, 42019658, 238198342, 195594778, 129156808, 224918267, 290674372, 75962072, 86059379, 153129360, 304751969, 199770260, 319992861, 43567056, 35167349, 304252405, 254323213, 286460365, 215924858, 10905663, 43059420, 50462715, 169237304, 132882643, 275661927, 97361183, 229491556, 70416186, 218886448, 22035689, 200825542, 131437653, 101792115, 16571560, 199418108, 298809842, 28621604, 222212223, 17445759, 265180666, 88756764, 153136403, 153941563, 285185004, 285910408, 62667842, 311364066, 285458223, 1902858, 108495474, 144025991, 278026555, 298231785, 57759433, 331313805, 230410126, 310396396, 253789896, 13113515, 268702835, 335332526, 66731212, 300714278, 202517236, 64091606, 95794102, 211473866, 18234984, 121832933, 221525645, 306939509, 205348582, 123579608, 8279468, 295210901, 282669864, 261526536, 219058614, 275819714, 80150445, 37949606, 53707726, 149301777, 54972373, 318779459, 85733326, 252620518, 117558064, 285044868, 153214448, 256810747, 269250233, 81706697, 11193866, 189180705, 227495352, 143594910, 211644369, 136505728, 324503760, 287518566, 304318635, 115238106, 217327121, 114930989, 89347090, 156222431, 16608724, 342648884, 320915221, 328901825, 100439094, 295761553, 181398441, 287251861, 277420382, 121194440, 31003376, 305459143, 93920407, 246732171, 132315265, 130430946, 104235797, 199568772, 130830619, 72887772, 262733750, 316185491, 233928307, 219127428, 195825333, 103862847, 120657022, 201255280, 42294589, 193373829, 198180869, 106947638, 151955888, 248884295, 279980280, 270636932, 334850163, 21613117, 232699472, 50732738, 207039089, 147059002, 23817218, 29792261, 247025432, 109962451, 123743170, 275116348, 61604108, 45330322, 153280692, 285869846, 166785494, 134838888, 237548219, 267827672, 144264653};

static uint32_t invgj[PARAM_N] = {230178281, 28412741, 251756114, 109063336, 246815665, 225881840, 149093995, 250162270, 41489976, 103569476, 102439370, 28969942, 165750795, 3526636, 90497882, 85554900, 43781479, 146992532, 63297910, 39223209, 112084443, 149611449, 248998375, 140836835, 99186991, 240959763, 71228862, 21557770, 168894963, 46950650, 332710318, 320590897, 172734379, 235746901, 102759627, 10477975, 280866177, 46610650, 128627582, 261495054, 93317755, 52012142, 97304235, 294073374, 115121720, 192744820, 11803800, 141579714, 28461713, 111932858, 248793181, 275718612, 207651332, 142711216, 245603797, 83331648, 225552962, 53269616, 4034460, 255392701, 83319558, 65178399, 198066724, 279581462, 48754688, 180774530, 279014153, 155925770, 238260955, 320475512, 240508762, 232830380, 296631722, 263370135, 39246706, 144719666, 333500206, 61177396, 123418251, 244412015, 64644010, 272031886, 331759676, 8430020, 238801802, 64454120, 86155713, 247733526, 11423383, 319798769, 19247575, 274904243, 244122100, 297985712, 46057960, 323686607, 220154025, 262360661, 317755526, 214379310, 180620362, 338298258, 140358520, 90481712, 152412582, 318540423, 281049782, 63075164, 304259250, 340761354, 169197199, 319458653, 406947, 39179546, 246892794, 122620980, 14529641, 38973391, 144410955, 198092564, 175510380, 36514570, 266482556, 144451146, 275496875, 254232996, 278272924, 189379798, 232577713, 186515503, 293610810, 275017072, 48408118, 210007756, 163834433, 329167214, 207446352, 89336972, 337119500, 165710878, 280816259, 61999846, 271894979, 312028904, 2444838, 223408413, 1894639, 123401430, 67818090, 280630256, 335021598, 207609902, 23037682, 144039014, 247060204, 316864540, 232882663, 254992215, 203070294, 68184325, 202186802, 225598796, 174220868, 323436926, 194556232, 178397376, 163263848, 33461804, 199475162, 308684897, 29062410, 302835287, 105583993, 7679073, 328283612, 3343374, 339420737, 331868388, 157385755, 165643927, 174194141, 248834966, 242538622, 287701598, 100899932, 139337501, 74978092, 42809240, 83510734, 268875464, 185029656, 267918498, 302198711, 27331164, 70150401, 214975506, 209925301, 43903345, 266174044, 81959363, 212602270, 150734566, 36455614, 176685332, 263374804, 236803717, 42386471, 280519482, 221572668, 165225660, 149880342, 162892249, 177431130, 285131401, 323195686, 120352305, 159437132, 39388443, 311149449, 289566549, 250985176, 180184975, 240662250, 3681317, 213828851, 218310121, 298478561, 276102835, 31380051, 96117749, 275893129, 26930094, 312296175, 29580462, 228607464, 296930296, 318239900, 283099602, 3824834, 236832444, 96295672, 318539830, 159253665, 280422720, 233694099, 337867102, 217666820, 214214071, 285511710, 50872171, 226035340, 2651478, 292490705, 327166891, 61013272, 110526487, 123338442, 117208829, 250179502, 8727606, 253031471, 42019658, 238198342, 147981799, 268825627, 24642697, 59358359, 296758271, 12784524, 307897724, 321796979, 141164020, 39849356, 327421373, 125065052, 24160836, 130173066, 313625303, 47219411, 280003099, 43119612, 108447337, 265513524, 99506849, 249111723, 316149201, 337358261, 185957490, 308409228, 304252405, 23583716, 43567056, 89253364, 286460365, 215924858, 332670914, 52902205, 75962072, 214419769, 224918267, 257517198, 153129360, 304751969, 143806317, 174339273, 132882643, 300517157, 50462715, 67914650, 97361183, 229491556, 273160391, 241784462, 16571560, 199418108, 44766735, 124690129, 22035689, 200825542, 212138924, 84644211, 231296935, 86016202, 288361849, 60080834, 170000837, 158868715, 29601494, 260292214, 324303657, 131916962, 298406441, 221624597, 289694837, 124133208, 71641144, 268071734, 50052329, 49471367, 233518338, 152582960, 175216519, 329355991, 147902490, 293720879, 225019453, 270924750, 72614779, 194083874, 193274358, 132014043, 278140865, 212264989, 37520514, 162736183, 44135208, 13532210, 105888842, 174998282, 315898307, 130322180, 79093301, 136470399, 270863055, 204510757, 273140786, 294856469, 54543017, 328589307, 60247524, 292131297, 247755013, 108261502, 166075088, 272609840, 214076344, 319534388, 69225428, 190429829, 169218502, 200580879, 88955326, 68556018, 60485642, 42862299, 202517236, 8244051, 66731212, 279484971, 95794102, 211473866, 325341593, 12262772, 230410126, 45344792, 57759433, 33180181, 253789896, 13113515, 74873742, 32212511, 285458223, 57666169, 62667842, 341673719, 108495474, 144025991, 65550022, 326130818, 265180666, 314954973, 222212223, 254819813, 153136403, 153941563, 58391573, 67756863, 80150445, 82050041, 219058614, 305626971, 53707726, 149301777, 288604204, 36637068, 205348582, 221743644, 221525645, 219996969, 8279468, 295210901, 60906713, 90956059, 117558064, 24797118, 85733326, 58531709, 153214448, 256810747, 74326344, 199981667, 211644369, 136505728, 19072817, 261869880, 11193866, 189180705, 116081225, 72939645, 334850163, 94692282, 279980280, 321963460, 232699472, 50732738, 136537488, 142321297, 42294589, 239713730, 120657022, 150202748, 198180869, 106947638, 191620689, 313784316, 247025432, 196517575, 23817218, 233614126, 123743170, 275116348, 281972469, 208737689, 237548219, 267827672, 199311924, 298246255, 153280692, 285869846, 176791083, 14674752, 100439094, 927693, 320915221, 47815024, 181398441, 287251861, 66156195, 228338471, 217327121, 56058011, 304318635, 228645588, 89347090, 156222431, 326967853, 38117434, 93920407, 222382137, 31003376, 96844406, 132315265, 130430946, 239340780, 27391086, 233928307, 219127428, 147751244, 144007805, 130830619, 72887772, 80842827, 154598651, 97199228, 29771154, 126118128, 18163265, 290160137, 232906613, 240733882, 158143973, 78929909, 14617725, 130223274, 439729, 227718820, 283979428, 30014721, 250560834, 239691382, 323515081, 182952855, 209981961, 280614798, 127536480, 157653053, 107543955, 28321279, 280343863, 55835601, 137122942, 80185663, 235487512, 262506464, 328351787, 266516977, 50441440, 42439927, 28976518, 243485818, 206404387, 153169223, 81831896, 293081123, 342547978, 82932498, 183700030, 294760797, 93972567, 26890320, 124725236, 326161710, 13804152, 86461881, 309349622, 10452203, 212453426, 306816260, 173913238, 260177771, 322532480, 73966285, 63353219, 37926728, 141832994, 310552168, 295496573, 315038284, 278884449, 112010821, 211033609, 16512596, 113847492, 265397543, 107111598, 86978974, 204046369, 17671546, 119087373, 66333293, 258747514, 85862909, 19113286, 262688005, 306438538, 256222701, 38968555, 259797397, 334403740, 195472069, 292279284, 160013839, 57854565, 223923169, 310632999, 220925134, 135351157, 211248056, 158586768, 303925075, 164433893, 21506004, 213108002, 94455759, 303231602, 186131829, 149863492, 256917885, 264741552, 107280313, 332499148, 102280532, 256238960, 117486497, 144362478, 341915426, 177069739, 44046295, 196373197, 1531480, 153751357, 74877012, 286710922, 58979299, 221951638, 138758194, 139551299, 183230445, 189831391, 128073009, 293364817, 213420941, 142805691, 187855677, 182248237, 144250570, 342838992, 191746123, 47119623, 189152222, 126022154, 204785799, 335823333, 249079456, 252046638, 218120023, 124340395, 217101561, 81332709, 176228476, 232372799, 246307069, 85727166, 203747422, 25768018, 158871763, 256558207, 74815679, 327355074, 19457767, 113932790, 95717370, 237885749, 159671104, 302168464, 104089631, 328438863, 21521721, 41440989, 283793334, 37818916, 129986654, 26762084, 313031241, 142220031, 181662736, 27177310, 176357631, 91372568, 259204440, 39964369, 46191317, 162025815, 335016012, 196719792, 284866497, 233709489, 167369833, 24290918, 52134224, 88361997, 186798925, 318124877, 48712415, 100010100, 136521473, 309252002, 83724843, 193681940, 253280727, 23456543, 276970473, 329845417, 32475051, 142133217, 117587332, 76589338, 106795166, 90314037, 22012503, 292642232, 266782762, 99584735, 98423244, 187475441, 110194417, 250329289, 69980662, 34710816, 44486585, 292832558, 317570457, 145523163, 268945886, 288454324, 335031859, 331226107, 211858578, 213649065, 35153582, 226525190, 47969593, 313832525, 206829851, 283346440, 77295331, 183586, 199091570, 222384416, 118499337, 310846214, 19639092, 103813462, 143625378, 277953894, 17526276, 160721164, 29364366, 6142389, 142214798, 24562963, 260499221, 274720457, 33282805, 218283561, 118380487, 343273701, 41575009, 80560710, 306330237, 717096, 306810545, 207261587, 255424040, 206110779, 79906091, 199361003, 277187326, 77916401, 210317395, 29879476, 300768811, 64515892, 209758099, 326150524, 38489313, 84895562, 245121768, 34653403, 204997768, 177321963, 97520073, 205205804, 171116152, 250369813, 329979744, 15379011, 306492713, 260886750, 282014613, 84797824, 93160951, 323543560, 87265135, 258242438, 97218674, 1174474, 117660839, 41938716, 270653181, 87811251, 214025278, 142075486, 311237060, 185114387, 23083138, 86861405, 299923615, 303596885, 3196461, 58576130, 3568958, 223869331, 105241299, 161488570, 116665263, 336219774, 321280820, 234236418, 228036934, 278155425, 36472172, 158880221, 291908351, 197323761, 95694269, 187045081, 329926849, 271769719, 207532476, 200949585, 281924067, 49724134, 149291842, 229213742, 341207087, 278533266, 301491566, 60065894, 190628200, 153705255, 287617162, 100586081, 242983932, 79652769, 118153340, 189546364, 296573439, 199344349, 215958457, 83496210, 198520556, 31448747, 176557714, 235702635, 329865979, 188814592, 287222275, 233235881, 201280444, 239137939, 174652008, 58016186, 201541966, 266295518, 219503197, 213845287, 236255384, 159737311, 213352941, 309282388, 246178438, 134483391, 123415395, 230279436, 152720619, 233823294, 257807803, 133463476, 160873555, 247066743, 185754674, 300653357, 282429854, 318416906, 223831137, 225422276, 112233406, 234832786, 247588627, 328467090, 41772654, 194698474, 2821533, 26259993, 255847428, 300107207, 170581572, 233114451, 238775901, 2154785, 323732830, 57499589, 181041403, 181580959, 325890756, 294520678, 25051422, 211128270, 307395502, 152760117, 89046591, 115538536, 252547736, 131947965, 317429505, 85260511, 61339023, 26740462, 279744541, 86251612, 1302564, 210761113, 76373990, 219744013, 207222761, 4168427, 208530917, 32321051, 232240022, 242403484, 253734832, 293775346, 63661913, 48985517, 124795282, 269103019, 89526458, 96009001, 339512484, 334761703, 245207630, 195685702, 338707806, 120358256, 110602220, 203499252, 61414236, 316900102, 114233824, 48133376, 35313167, 286432498, 316576276, 59887801, 309570728, 271991249, 34982648, 143444237, 173674013, 915757, 199378297, 111108805, 18041912, 176271658, 276514612, 3575964, 332577083, 286580052, 313070540, 150950489, 241285659, 111488825, 176966297, 212401656, 83977365, 260103755, 99774609, 63514813, 321709631, 245056013, 53614654, 207371027, 69950446, 90774036, 91855681, 183751722, 70109818, 3291719, 196610457, 54009400, 29520420, 35491863, 25050732, 64939542, 278637035};

void poly_uniform(poly_k a, const unsigned char *seed)         
{ // Generation of polynomials "a_i"
  unsigned int pos=0, i=0, nbytes = (PARAM_Q_LOG+7)/8;
  unsigned int nblocks=PARAM_GEN_A;
  uint32_t val1, val2, val3, val4, mask = (uint32_t)(1<<PARAM_Q_LOG)-1;
  unsigned char buf[SHAKE128_RATE*PARAM_GEN_A];
  uint16_t dmsp=0;

  cshake128_simple(buf, SHAKE128_RATE*PARAM_GEN_A, dmsp++, seed, CRYPTO_RANDOMBYTES);    
     
  while (i < PARAM_K*PARAM_N) {   
    if (pos > SHAKE128_RATE*nblocks - 4*nbytes) {
      nblocks = 1;
      cshake128_simple(buf, SHAKE128_RATE*nblocks, dmsp++, seed, CRYPTO_RANDOMBYTES);    
      pos = 0;
    } 
    val1  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val2  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val3  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val4  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    if (val1 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val1*PARAM_R2_INVN);
    if (val2 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val2*PARAM_R2_INVN);
    if (val3 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val3*PARAM_R2_INVN);
    if (val4 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val4*PARAM_R2_INVN);
  }
}


int32_t reduce(int64_t a)
{ // Montgomery reduction
  int64_t u;

  u = (a*PARAM_QINV) & 0xFFFFFFFF;
  u *= PARAM_Q;
  a += u;
  return (int32_t)(a>>32);
}


int64_t barr_reduce64(int64_t a)
{ // Barrett reduction
  int64_t u = (a*PARAM_BARR_MULT)>>PARAM_BARR_DIV;
  return a - u*PARAM_Q;
}


sdigit_t barr_reduce(sdigit_t a)
{ // Barrett reduction
  digit_t u = ((int64_t)a*PARAM_BARR_MULT)>>PARAM_BARR_DIV;
  return a - (digit_t)u*PARAM_Q;
}


void dgt(poly x)
{
  int m, distance, jtwiddle;
  int j1, j2, j, k;
  int64_t temp_re, temp_img;
  int64_t a, b, c, d;
  int64_t copy[PARAM_N];

  for(j = 0; j < PARAM_N; ++j)
    copy[j] = (int64_t) x[j];
  
  distance = 512;
  jtwiddle = 0;
  for(m = 1; m < 512; m <<= 1)
  {
    for(k = 0; k < m; ++k)
    {
      j1 = 2 * k * distance;
      j2 = j1 + distance - 1;
      for(j = j1; j <= j2; j = j+2)
      {
        a = reduce(gj[jtwiddle] * copy[j + distance]);
        b = reduce(gj[jtwiddle + 1] * copy[j + distance + 1]);
        c = reduce(gj[jtwiddle] * copy[j + distance + 1]);
        d = reduce(gj[jtwiddle + 1] * copy[j + distance]);

        temp_re = barr_reduce64(a - b);
        temp_img = barr_reduce64(c + d);

        copy[j + distance] = barr_reduce64(copy[j] - temp_re);
        copy[j + distance + 1] = barr_reduce64(copy[j + 1] - temp_img);
        
        copy[j] = barr_reduce64(copy[j] + temp_re);
        copy[j + 1] = barr_reduce64(copy[j + 1] + temp_img);
      }
      jtwiddle += 2;
    }
    distance >>= 1;
  }

  for(j = 0; j < PARAM_N; ++j)
    x[j] = (int32_t) barr_reduce64(copy[j]);

}


void idgt(poly x) 
{
  int distance, j1, jtwiddle, m, j, h;
  int64_t temp_re, temp_img, sum_re, sum_img;
  int64_t a, b, c, d;
  int64_t copy[PARAM_N];

  for(j = 0; j < PARAM_N; ++j)
    copy[j] = (int64_t) x[j];

  jtwiddle = 0;
  distance = 2;
  h = 0; 
  for(m = 512; m > 1; m >>= 1)
  {
    for(j1 = 0; j1 < distance; j1 = j1 + 2)
    {
      jtwiddle = h;
      for(j = j1; j < PARAM_N; j = j + 2*distance)
      {
        temp_re = copy[j];
        temp_img = copy[j + 1];
        
        copy[j] = barr_reduce64(temp_re + copy[j + distance]);
        copy[j + 1] = barr_reduce64(temp_img + copy[j + distance + 1]);
        
        sum_re = barr_reduce64(temp_re - copy[j + distance]);
        sum_img = barr_reduce64(temp_img - copy[j + distance + 1]);

        a = reduce(invgj[jtwiddle] * sum_re);
        b = reduce(invgj[jtwiddle + 1] * sum_img);
        c = reduce(invgj[jtwiddle] * sum_img);
        d = reduce(invgj[jtwiddle + 1] * sum_re);

        copy[j + distance] = barr_reduce64(a - b);
        copy[j + distance + 1] = barr_reduce64(c + d);

        jtwiddle += 2;
      }
    }
    h += m;
    distance <<= 1;
  }

  for(j = 0; j < PARAM_N; ++j)
    x[j] = (int32_t) barr_reduce(reduce(copy[j] * (int64_t)512)); // invofkmodp * 2**18 mod p

}


static void poly_pointwise(poly result, const poly x, const poly y)
{ // Pointwise polynomial multiplication result = x.y

  for (int i=0; i<PARAM_N; i++)
    result[i] = reduce((int64_t)x[i]*y[i]);
}


void poly_dgt(poly x_dgt, const poly x)
{
  int i, j;

  j = 0;
  for(i = 0; i < PARAM_N; i += 2) {             
    x_dgt[i] = x[j];      
    x_dgt[i+1] = x[512+j];

    j++;
  } 

  dgt(x_dgt);
}


void poly_mul(poly _output, const poly _poly_a, const poly _poly_b)
{ /* It is assumed that both signals are already in the DGT domain. 
     The DGT counterpart of poly_b was computed in sign.c. */
  
  poly _mul;
  int i, j;
  int64_t copy[PARAM_N];

  for(j = 0; j < PARAM_N; j++) {
    copy[j] = reduce((int64_t)4161336 * _poly_a[j]); // R^2. R = 2^18 mod p
  }

  /* Calculating the point-wise multiplication of input signals. _poly_a is being folded during multiplication. */
  i = 0;
  for(j = 0; j < 512; j++) {             
    _mul[i] = barr_reduce64(reduce(copy[j] * (int64_t)_poly_b[i]) - 
              reduce(copy[j + 512] * (int64_t)_poly_b[i+1]));

    _mul[i+1] = barr_reduce64(reduce(copy[j] * (int64_t)_poly_b[i+1]) + 
                reduce(copy[j + 512] * (int64_t)_poly_b[i]));

    i += 2;
  }

  /* Recovering the multiplication result in Z[x]/<x^n+1> */
  idgt(_mul);

  /* Writing the result from the Gaussian integer to the polynomial form */
  i = 0;
  for(j = 0; j < 512; j++) {
    _output[j] = _mul[i];
    _output[j+512] = _mul[i+1];
    i += 2;
  }

}


void poly_add(poly result, const poly x, const poly y)
{ // Polynomial addition result = x+y

    for(int i=0; i<PARAM_N; i++)
      result[i] = x[i] + y[i];
}


void poly_add_correct(poly result, const poly x, const poly y)
{ // Polynomial addition result = x+y with correction

    for (int i=0; i<PARAM_N; i++) {
      result[i] = x[i] + y[i];
      result[i] += (result[i] >> (RADIX32-1)) & PARAM_Q;    // If result[i] < 0 then add q
      result[i] -= PARAM_Q;
      result[i] += (result[i] >> (RADIX32-1)) & PARAM_Q;    // If result[i] >= q then subtract q
    }
}


void poly_sub(poly result, const poly x, const poly y)
{ // Polynomial subtraction result = x-y

    for (int i=0; i<PARAM_N; i++)
      result[i] = x[i] - y[i];
}    


void poly_sub_reduce(poly result, const poly x, const poly y)
{ // Polynomial subtraction result = x-y

    for (int i=0; i<PARAM_N; i++)
      result[i] = (int32_t)barr_reduce(x[i] - y[i]);
}


/********************************************************************************************
* Name:        sparse_mul8
* Description: performs sparse polynomial multiplication
* Parameters:  inputs:
*              - const unsigned char* s: part of the secret key
*              - const uint32_t pos_list[PARAM_H]: list of indices of nonzero elements in c
*              - const int16_t sign_list[PARAM_H]: list of signs of nonzero elements in c
*              outputs:
*              - poly prod: product of 2 polynomials
*
* Note: pos_list[] and sign_list[] contain public information since c is public
*********************************************************************************************/
void sparse_mul8(poly prod, const unsigned char *s, const uint32_t pos_list[PARAM_H], const int16_t sign_list[PARAM_H])
{
  int i, j, pos;
  int8_t *t = (int8_t*)s;

  for (i=0; i<PARAM_N; i++)
    prod[i] = 0;

  for (i=0; i<PARAM_H; i++) {
    pos = pos_list[i];
    for (j=0; j<pos; j++) {
        prod[j] = prod[j] - sign_list[i]*t[j+PARAM_N-pos];
    }
    for (j=pos; j<PARAM_N; j++) {
        prod[j] = prod[j] + sign_list[i]*t[j-pos];
    }
  }
}


/********************************************************************************************
* Name:        sparse_mul32
* Description: performs sparse polynomial multiplication 
* Parameters:  inputs:
*              - const int32_t* pk: part of the public key
*              - const uint32_t pos_list[PARAM_H]: list of indices of nonzero elements in c
*              - const int16_t sign_list[PARAM_H]: list of signs of nonzero elements in c
*              outputs:
*              - poly prod: product of 2 polynomials
*********************************************************************************************/
void sparse_mul32(poly prod, const int32_t *pk, const uint32_t pos_list[PARAM_H], const int16_t sign_list[PARAM_H])
{
  int i, j, pos;
  int64_t temp[PARAM_N] = {0};
  
  for (i=0; i<PARAM_H; i++) {
    pos = pos_list[i];
    for (j=0; j<pos; j++) {
        temp[j] = temp[j] - sign_list[i]*pk[j+PARAM_N-pos];
    }
    for (j=pos; j<PARAM_N; j++) {
        temp[j] = temp[j] + sign_list[i]*pk[j-pos];
    }
  }
  for (i=0; i<PARAM_N; i++)
    prod[i] = (int32_t)barr_reduce64(temp[i]);
}