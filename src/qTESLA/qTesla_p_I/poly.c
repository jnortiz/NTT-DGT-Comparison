/*************************************************************************************
* qTESLA: an efficient post-quantum signature scheme based on the R-LWE problem
*
* Abstract: NTT, modular reduction and polynomial functions
**************************************************************************************/

#include "poly.h"
#include "sha3/fips202.h"
#include "api.h"

static int32_t gj[PARAM_N] = {256373736, 256373736, 163252752, 250317441, 167115108, 142816427, 101196009, 98070244, 61863585, 240222969, 173331003, 102761201, 333578084, 108258464, 180081655, 15281668, 313511855, 126451566, 223659064, 16421670, 247152515, 12096576, 43384894, 22285569, 119301314, 143503407, 216338584, 65593132, 104484234, 300569934, 205620403, 122829988, 273714987, 328917891, 216984249, 317394855, 229969877, 112076068, 52972328, 129377878, 116419926, 273602181, 234588408, 331549037, 341158566, 189876985, 234966047, 32142094, 179825468, 26923255, 163000491, 161993229, 10070686, 250567250, 98416529, 204533852, 159637389, 30159510, 305414747, 102816253, 276821036, 261250030, 123565446, 49389813, 133606517, 113201002, 291940501, 46363871, 269426719, 326511470, 7147987, 214139724, 13707958, 85757511, 106235613, 212065110, 340175021, 121137475, 311490536, 156598330, 257725669, 170020952, 193641325, 141456262, 259186586, 96509006, 213719999, 226996706, 129632766, 10283800, 178699568, 342198329, 174857148, 154841223, 246982150, 253506750, 76230855, 45062440, 206548264, 258482365, 51001671, 61705180, 327626770, 39460802, 287982844, 23022564, 178100035, 5558726, 290535186, 86017690, 134349345, 73080659, 16173344, 21690561, 225673699, 67756226, 222843301, 302681518, 278935017, 218625168, 305616121, 198219080, 142074996, 283398377, 163690901, 259671195, 195159629, 137397147, 101934359, 277786795, 173258611, 196399257, 43077586, 227272671, 61518175, 71781337, 289087980, 216405436, 322683999, 238148219, 244810705, 80398645, 2293704, 52987371, 242135014, 333832733, 238257084, 213741634, 247447605, 161710427, 144408485, 295966687, 314345521, 161161835, 33453449, 55564794, 179905148, 259898292, 303083257, 205783595, 172849548, 121185840, 130904112, 335138218, 3683135, 197691180, 98263389, 132889976, 195086791, 17833952, 128085283, 138639640, 67682457, 109611896, 248404380, 188940003, 206530917, 238813077, 67297246, 84928807, 229040383, 52033808, 195330429, 232867630, 291732190, 301622179, 292289136, 122644487, 156752901, 223770862, 127127850, 229688835, 209087812, 316632388, 234165087, 176747924, 116290768, 202232707, 18873054, 231807035, 282524850, 144303935, 223551603, 78664955, 108594652, 150384413, 266214753, 165295785, 187116841, 312368502, 240487231, 228594132, 157393512, 303105633, 60147389, 267688912, 207239826, 343164037, 145962318, 341147536, 238642147, 37369815, 232285045, 150810761, 77984910, 212768127, 318352597, 118621569, 294822937, 278932851, 250392166, 219228388, 204379442, 50910603, 190826539, 269081603, 230260162, 26490946, 265863675, 340316827, 144254756, 167173624, 47216639, 302187677, 267733841, 256542287, 19289843, 253900542, 215287396, 201485788, 83887387, 93588595, 261561231, 336183291, 84164080, 141270259, 56926277, 160794083, 178342891, 185983013, 214879920, 57119740, 207247283, 94252648, 29263748, 1811116, 184044939, 53098339, 100962655, 155198466, 216183957, 10678199, 302347101, 126991859, 289893093, 269828176, 293564165, 199890997, 250791273, 179500292, 41146024, 31959513, 142335140, 217552860, 249939458, 124518946, 43861551, 71959461, 271462350, 168181759, 72733684, 251445197, 95615486, 104444747, 180021072, 147606765, 72395, 31814000, 265271052, 36328785, 17914893, 200783070, 248051523, 293916572, 198779318, 206472298, 189760400, 240070418, 4486891, 209461179, 66541170, 177455666, 304993594, 297064887, 150128330, 102287194, 11220515, 285419816, 333099577, 48531736, 79896191, 237745411, 245595967, 14879080, 326262834, 79314803, 71558502, 4006565, 248805774, 302345353, 6364458, 99434075, 130885275, 63227880, 57457056, 147758606, 62629997, 334870824, 95213372, 186954559, 93838702, 318345244, 229638246, 341585802, 164398060, 274550216, 183383445, 282384858, 34300979, 138516241, 10588181, 47097237, 4942618, 240469400, 223690102, 308969805, 23932231, 32421954, 293958499, 258165236, 180483230, 75181272, 245804237, 34717157, 235424373, 293701503, 231393054, 194673595, 268523583, 21085534, 207814317, 23327578, 115233725, 206058005, 204104713, 187456186, 222170056, 133937767, 206013475, 329261287, 318621302, 74927856, 3357310, 301956650, 341379825, 35586266, 187025164, 213714890, 66272004, 207288912, 297594159, 102308862, 61847624, 295408862, 12577872, 59310658, 133216183, 109613924, 185257519, 266523033, 308779868, 235111697, 258568454, 199053240, 262842511, 100661403, 64682889, 102682835, 120724346, 307820983, 101311678, 24181011, 234839947, 66560716, 249392783, 258802075, 85238029, 205097122, 8665287, 9280708, 195319943, 158320166, 68915699, 281642274, 284164132, 95740856, 147150502, 109873215, 315528551, 275141375, 319687498, 188121631, 12840968, 335836661, 216069930, 287250320, 165138650, 90202324, 72406221, 18817640, 133820470, 101142000, 23288519, 193683925, 155165446, 43008928, 245521989, 240069660, 264441646, 102556698, 272244082, 214694388, 292164999, 226596328, 331936789, 33534162, 193387426, 75199384, 294793890, 84297362, 61019749, 153444249, 320549613, 273992570, 121471327, 295447818, 304379524, 331136591, 294710644, 182022742, 260802168, 142288823, 65309044, 49314600, 139827781, 160992873, 173634789, 303780378, 258911729, 98564744, 312540892, 89094782, 167871319, 2217279, 232647738, 79512388, 232162452, 110997370, 166808788, 294127156, 191328271, 147404735, 69273431, 287454734, 269048371, 174180113, 208614795, 339076744, 327073204, 280361098, 68114484, 221632141, 58635464, 327016859, 259260408, 343315735, 68769305, 164369321, 260249236, 58099219, 116677110, 152963600, 338320820, 103438506, 126926529, 140680816, 125506348, 154779824, 245849068, 267334057, 327096647, 17363257, 313360654, 325733092, 35914700, 277386860, 190887627, 179818263, 247322523, 6693868, 189018384, 125391844, 91678747, 336254018, 263056658, 155199477, 58370123, 113511145, 128980763, 206628819, 321621612, 218636101, 167152278, 205215921, 225430061, 203315838, 75610952, 20089668, 135143242, 91098142, 196253594, 139635858, 78460885, 160855894, 203380185, 181747225, 139578524, 273241349, 252054955, 139856836, 338928113, 28370090, 316832649, 252367121, 271886197, 294971368, 38385276, 164164367, 177185955, 126174359, 314815792, 316450439, 294663654, 192409727, 184847878, 66544890, 141276235, 251274540, 211913570, 244850817, 251701805, 179047604, 223703131, 204450052, 142233717, 202163811, 338640035, 104360890, 14467480, 271054509, 314740429, 64913698, 202045093, 60731228, 283931728, 193115252, 257015131, 137902624, 239720114, 216476870, 54565715, 99925314, 199710981, 191232226, 243130748, 45894993, 38610282, 63993751, 242922793, 46139008, 19923883, 64904850, 250962650, 194412704, 343076981, 209048513, 136791466, 13858298, 94176318, 56667845, 171233687, 110020156, 277577042, 342294822, 61120314, 232337967, 93818995, 32420262, 289669843, 167654808, 225640335, 260308459, 149745033, 301253097, 146002636, 182838796, 154796553, 196782074, 51028886, 85769419, 88527393, 40232046, 222023034, 318322815, 119453548, 166673484, 174493133, 343240303, 119127051, 95063380, 121334908, 205480959, 162623476, 147590694, 157321040, 65049867, 220124994, 78061297, 174505504, 117580955, 136468739, 282127752, 262050810, 195965685, 18733333, 179805780, 49581154, 133538894, 15794995, 37788511, 237233243, 288719937, 330394725, 38085802, 312580270, 258224263, 151085180, 35003266, 109333297, 7268369, 206936323, 30514977, 284623270, 101318908, 75961819, 80560347, 179080702, 129890601, 204111892, 116635828, 44929717, 174758078, 160777498, 219354343, 168268626, 174563493, 305986603, 41456455, 173883570, 87894323, 222633565, 211462889, 115957061, 5782524, 37548666, 189887262, 334253943, 315070274, 283456007, 37452728, 184728523, 144857266, 72140840, 197416095, 25289953, 158680098, 304677279, 333163069, 4940565, 164276891, 166279099, 301157558, 311815905, 59539288, 184368933, 60952560, 208211686, 295496624, 199129825, 311663286, 68455930, 184755693, 270128187, 209931930, 306307617, 123820345, 341246307, 97023568, 81147250, 118811673, 303422926, 187013728, 255075109, 226430477, 303775790, 332923927, 153228370, 241735506, 279156747, 64950454, 308608601, 28904612, 260285774, 239754023, 279418543, 141956459, 3740224, 67596166, 265678726, 46887900, 44436251, 243827733, 49932804, 84882964, 133889856, 65118099, 178270840, 258429562, 154232503, 142046742, 274605096, 205347840, 103528297, 139785168, 301844792, 239264897, 195670512, 283645614, 287534189, 165146461, 298414759, 11201421, 112740499, 340015211, 188416125, 322929560, 163445065, 193374730, 168720609, 232660313, 61665286, 342600266, 207888325, 262915307, 326085426, 261980246, 312455785, 139249028, 65345900, 185224588, 129828935, 237371717, 198112793, 53722399, 241715476, 9886249, 228191825, 226129864, 276109195, 77605123, 238740102, 164650055, 25317223, 303270617, 86124139, 204452314, 237755702, 343504072, 129418283, 191328529, 287694137, 146454497, 336414046, 335798127, 69968699, 221666117, 168467334, 43131675, 326999176, 187039622, 193040758, 49356151, 265295881, 166689741, 243265128, 28034332, 161354025, 109568676, 24893260, 50920320, 247224173, 210678531, 167876672, 249255317, 251954997, 207258665, 137935631, 135370937, 212644372, 43469673, 120070754, 205006502, 139129871, 126212684, 271179419, 65240672, 140392186, 99965483, 270933795, 266192941, 298873762, 86109073, 17004529, 202098203, 93977051, 128225754, 302170105, 75268986, 201443132, 125467338, 128046181, 194095075, 3926387, 262424404, 278372513, 110578340, 248436680, 18562552, 122824699, 135878298, 121012346, 248031040, 130907303, 283151838, 231171393, 312222435, 326829883, 277322726, 236378776, 280098693, 41307402, 82943210, 196610779, 77805655, 297908908, 187651740, 319179969, 194215579, 174747512, 190661498, 326493012, 173234913, 33073854, 143111252, 307418625, 183159508, 254533542, 268213195, 37905708, 48819254, 227063923, 120657214, 79041097, 163652885, 257635887, 129921210, 116469135, 180567539, 298639754, 63509394, 14616572, 123390535, 106853392, 32763432, 161618076, 193932443, 274438479, 276784829, 310134484, 129325504, 31529211, 281632374, 207927555, 194370393, 107274057, 55408434, 311053472, 35213586, 236316911, 47769087, 238662705, 153150915, 175109279, 113766408, 211120370, 324606491, 282282728, 95044470, 148516906, 216145369, 108179656, 273985003, 132369603, 165139872, 190182721, 206526612, 169907859, 165651342, 269314674, 316806993, 107838089, 203483013, 229681816, 226504540, 246387431, 4685032, 261623853, 122623033, 72467132, 205888843, 296818921, 94666294, 22538878, 81001555, 120666477, 153131578, 106178330, 256036482, 281461259, 228677467, 277886901, 223710358, 260053716, 298174370, 264651373, 302403344, 279033115, 84665453, 152127279, 84179846, 297675944, 248600967, 62098051, 304166944, 117197819, 196705046, 333134869, 89392050, 153473444, 106027993, 259767703, 297865633, 225434618, 222450856, 93439629, 340466032, 255730844, 261884817, 237664884, 276177405, 252803973, 306292980, 125131969, 237298823, 223012751, 149656435, 55659200, 149016815, 2950882, 298132417, 272113181, 168801569};

static int32_t invgj[PARAM_N] = {144446752, 311663286, 135364891, 295496624, 275120647, 184755693, 270128187, 133644647, 177297478, 301157558, 338636012, 164276891, 31760672, 59539288, 184368933, 282624017, 271435737, 197416095, 158848054, 144857266, 318286624, 158680098, 304677279, 10413508, 306027911, 189887262, 227619516, 5782524, 9322634, 315070274, 283456007, 306123849, 39800787, 332923927, 88501468, 226430477, 190348207, 241735506, 279156747, 278626123, 2330270, 97023568, 37268960, 123820345, 262429327, 118811673, 303422926, 156562849, 83290803, 239754023, 34967976, 28904612, 64158034, 141956459, 3740224, 275980411, 293643773, 84882964, 133889856, 278458478, 77897851, 46887900, 44436251, 99748844, 324843244, 179805780, 81525767, 195965685, 293995423, 133538894, 15794995, 305788066, 123451583, 78061297, 186255537, 65049867, 169071073, 117580955, 136468739, 61448825, 224449526, 95063380, 169083444, 343240303, 222241669, 205480959, 162623476, 195985883, 255049184, 40232046, 292547691, 85769419, 121553543, 318322815, 119453548, 176903093, 136640254, 30514977, 234243280, 7268369, 58953307, 101318908, 75961819, 263016230, 13181852, 38085802, 106343334, 288719937, 30996307, 258224263, 151085180, 308573311, 139464685, 116635828, 164495875, 129890601, 298646860, 174758078, 160777498, 124222234, 169693007, 87894323, 222633565, 132113688, 175307951, 174563493, 305986603, 302120122, 289010862, 99925314, 103856463, 216476870, 143865596, 191232226, 243130748, 297681584, 141531484, 60731228, 28836148, 64913698, 59644849, 193115252, 257015131, 205673953, 201342860, 202163811, 119873446, 204450052, 4936542, 104360890, 14467480, 72522068, 202300342, 251274540, 158728699, 66544890, 131663007, 244850817, 251701805, 164528973, 206785111, 13858298, 499596, 209048513, 249400259, 56667845, 171233687, 233556421, 100653784, 46139008, 304966295, 63993751, 323652694, 64904850, 250962650, 149163873, 282456263, 232337967, 65999535, 342294822, 249757582, 32420262, 289669843, 175921769, 197573941, 182838796, 154796553, 146794503, 117936242, 260308459, 149745033, 42323480, 285206454, 113511145, 80519919, 155199477, 214595814, 206628819, 321621612, 124940476, 96254054, 6693868, 152688950, 179818263, 154558193, 125391844, 91678747, 7322559, 16479930, 17363257, 97727509, 267334057, 30215923, 325733092, 35914700, 66189717, 5255757, 103438506, 226899467, 152963600, 216650048, 140680816, 125506348, 188796753, 265115692, 160855894, 147322983, 139635858, 140196392, 181747225, 139578524, 70335228, 118146516, 203315838, 176424299, 205215921, 267965625, 20089668, 135143242, 252478435, 4648464, 28370090, 91521622, 139856836, 26743928, 252367121, 271886197, 48605209, 28760785, 316450439, 294663654, 151166850, 305191301, 164164367, 177185955, 217402218, 203184391, 99965483, 72397158, 65240672, 72642782, 266192941, 298873762, 257467504, 130932205, 43469673, 205640946, 135370937, 223505823, 205006502, 139129871, 217363893, 96352404, 210678531, 318683317, 50920320, 175699905, 249255317, 251954997, 136317912, 78280696, 166689741, 150535819, 49356151, 100311449, 28034332, 161354025, 234007901, 339650190, 262424404, 215530396, 194095075, 65204064, 110578340, 248436680, 325014025, 249599526, 128225754, 326572048, 202098203, 41406472, 75268986, 201443132, 218109239, 222564231, 248031040, 220751878, 135878298, 212669274, 283151838, 231171393, 31354142, 302269175, 82943210, 196610779, 265770922, 16746694, 277322726, 236378776, 63477884, 135688252, 262915307, 281911291, 342600266, 17491151, 261980246, 312455785, 204327549, 155160452, 322929560, 230836078, 340015211, 180131512, 193374730, 168720609, 110916264, 147906065, 283645614, 41731785, 239264897, 56042388, 165146461, 298414759, 332375156, 189344074, 142046742, 165305737, 258429562, 68971481, 205347840, 103528297, 203791409, 67467382, 77605123, 115384752, 226129864, 104836475, 164650055, 25317223, 40305960, 213747642, 237371717, 278230677, 185224588, 145463784, 53722399, 241715476, 333690328, 105820875, 343504072, 257452438, 204452314, 214158294, 191328529, 287694137, 197122080, 175109243, 43131675, 326999176, 156536955, 7162531, 335798127, 69968699, 121910460, 328960005, 123390535, 44936823, 63509394, 236723185, 32763432, 161618076, 149644134, 264535480, 163652885, 116512654, 120657214, 85940690, 129921210, 116469135, 163009038, 36157952, 183159508, 310502723, 143111252, 89043035, 268213195, 37905708, 294757323, 24396608, 194215579, 45667669, 187651740, 168829065, 190661498, 326493012, 170341664, 32523105, 35213586, 236302520, 55408434, 107259666, 47769087, 238662705, 190425662, 33442093, 129325504, 69138098, 276784829, 312047366, 281632374, 207927555, 149206184, 132456207, 324606491, 168467298, 113766408, 61293849, 95044470, 148516906, 127431208, 153393856, 206526612, 169907859, 177925235, 235396921, 273985003, 132369603, 178436705, 83808874, 297865633, 190103133, 106027993, 118141959, 222450856, 93439629, 3110545, 281478526, 304166944, 45900633, 248600967, 226378758, 196705046, 333134869, 254184527, 105911693, 276177405, 87845733, 261884817, 90772604, 306292980, 125131969, 106277754, 340625695, 298132417, 272113181, 174775008, 120563826, 149656435, 55659200, 194559762, 271109445, 205888843, 81952724, 122623033, 46757656, 94666294, 22538878, 262575022, 235738488, 203483013, 74261903, 316806993, 113894761, 226504540, 246387431, 338891545, 237398247, 256036482, 222910100, 153131578, 62115318, 228677467, 277886901, 119866219, 64543462, 84665453, 152127279, 259396731, 83522861, 298174370, 264651373, 41173233, 97772340, 34717157, 235424373, 49875074, 49618078, 258165236, 180483230, 268395305, 119886475, 308969805, 23932231, 311154623, 332988396, 47097237, 4942618, 103107177, 135762260, 23327578, 115233725, 137518572, 112183523, 194673595, 268523583, 322491043, 139471864, 187456186, 222170056, 209638810, 318621302, 268648721, 206013475, 14315290, 337212119, 99434075, 130885275, 280348697, 272018075, 4006565, 248805774, 41231224, 97980610, 14879080, 326262834, 264261774, 10477000, 48531736, 79896191, 105831166, 248363205, 186954559, 93838702, 25231333, 286119521, 147758606, 62629997, 8705753, 113938331, 341585802, 164398060, 69026361, 34300979, 205060336, 183383445, 61191719, 78305525, 36328785, 17914893, 142793507, 163555505, 147606765, 72395, 311762577, 270842893, 251445197, 95615486, 239131830, 299715026, 71959461, 271462350, 175394818, 153816177, 240070418, 4486891, 134115398, 95525054, 293916572, 198779318, 137104279, 277035407, 177455666, 304993594, 46511690, 11220515, 58156761, 150128330, 241289383, 159531638, 53098339, 100962655, 188378111, 136329294, 94252648, 29263748, 341765461, 165233686, 185983013, 214879920, 286456837, 259412497, 141270259, 56926277, 182782494, 53683484, 269828176, 293564165, 143685580, 127392620, 10678199, 302347101, 216584718, 92785304, 179500292, 41146024, 311617064, 249939458, 219057631, 142335140, 126023717, 196426075, 109873215, 315528551, 68435202, 274660878, 281642274, 284164132, 247835721, 334911290, 9280708, 195319943, 185256411, 94183794, 258802075, 85238029, 138479455, 127506647, 287250320, 165138650, 253374253, 23889079, 188121631, 12840968, 7739916, 271170356, 18817640, 133820470, 242434577, 155165446, 300567649, 23288519, 149892652, 330998705, 59310658, 133216183, 233962653, 45982418, 102308862, 61847624, 48167715, 156551413, 213714890, 66272004, 136287665, 340219267, 301956650, 341379825, 307990311, 85008123, 199053240, 262842511, 242915174, 158319058, 266523033, 308779868, 108464880, 278893688, 102682835, 120724346, 35755594, 234839947, 277015861, 101311678, 319395566, 48782687, 84297362, 61019749, 190132328, 11639788, 33534162, 193387426, 268377193, 71332495, 214694388, 292164999, 116980249, 98054588, 240069660, 264441646, 241019879, 39197053, 331136591, 294710644, 161553835, 23026964, 273992570, 121471327, 48128759, 82774409, 142288823, 65309044, 294261977, 173634789, 39796199, 139827781, 182583704, 16503373, 280361098, 68114484, 121944436, 74528206, 174180113, 208614795, 4499833, 284941113, 327016859, 259260408, 260842, 260249236, 285477358, 68769305, 179207256, 175705258, 2217279, 232647738, 264064189, 84664848, 98564744, 312540892, 254481795, 111414125, 110997370, 166808788, 49449421, 69273431, 56121843, 191328271, 196171842, 229040383, 291542769, 67297246, 258647770, 206530917, 104763500, 248404380, 154636574, 291732190, 41954398, 195330429, 110708947, 292289136, 220932090, 186823676, 223770862, 3683135, 145885397, 130904112, 8438359, 172849548, 222390737, 303083257, 137792982, 195086791, 325742625, 98263389, 210686601, 128085283, 204936937, 275894120, 109611896, 247447605, 181866150, 238257084, 129834943, 242135014, 9743844, 2293704, 290589206, 314345521, 182414742, 144408485, 47609890, 33453449, 288011783, 163671429, 259898292, 43077586, 116303906, 173258611, 147177320, 101934359, 65789782, 195159629, 206179430, 289087980, 127171141, 61518175, 271795240, 322683999, 105428358, 98765872, 80398645, 157393512, 40470944, 240487231, 114982445, 187116841, 31208075, 266214753, 178280792, 207239826, 412540, 60147389, 75887665, 145962318, 2429041, 104934430, 37369815, 116290768, 141343870, 234165087, 166828653, 209087812, 26944189, 127127850, 113887742, 282524850, 199272642, 18873054, 111769542, 223551603, 264911622, 234981925, 150384413, 294822937, 64643726, 318352597, 224955008, 77984910, 130808450, 232285045, 192765816, 204379442, 292665974, 250392166, 124348189, 190826539, 74494974, 113316415, 26490946, 215287396, 142090789, 19289843, 89676035, 83887387, 249987982, 82015346, 336183291, 144254756, 176402953, 265863675, 3259750, 47216639, 41388900, 75842736, 256542287, 213943811, 10283800, 129856578, 226996706, 164877009, 342198329, 174857148, 188735354, 85850908, 170020952, 32086041, 156598330, 149935252, 141456262, 259186586, 247067571, 329868619, 85757511, 336428590, 214139724, 237340964, 212065110, 340175021, 222439102, 209970060, 113201002, 220011131, 49389813, 51636076, 46363871, 269426719, 17065107, 55593733, 23022564, 15949807, 39460802, 165476542, 5558726, 290535186, 257558887, 267345722, 45062440, 96594427, 253506750, 137028313, 258482365, 51001671, 281871397, 327403233, 21690561, 209227232, 73080659, 117902878, 67756226, 222843301, 40895059, 201501581, 283398377, 163690901, 83905382, 64641560, 218625168, 305616121, 145357497, 108988169, 331549037, 341158566, 153699592, 290604249, 129377878, 116419926, 69974396, 126592328, 317394855, 229969877, 231500509, 137956174, 122829988, 273714987, 14658686, 180576086, 161993229, 10070686, 93009327, 108610530, 32142094, 179825468, 316653322, 245160048, 204533852, 159637389, 313417067, 276821036, 82326547, 305414747, 240760324, 247152515, 331480001, 223659064, 327154907, 313511855, 217125011, 180081655, 328294909, 119301314, 200073170, 43384894, 321291008, 216338584, 277983445, 239092343, 300569934, 281712992, 240222969, 242380568, 98070244, 170245574, 102761201, 333578084, 235318113, 180323825, 250317441, 167115108, 200760150, 256373736, 87202841};


void poly_uniform(poly_k a, const unsigned char *seed)         
{ // Generation of polynomials "a_i"
  unsigned int pos=0, i=0, nbytes = (PARAM_Q_LOG+7)/8;
  unsigned int nblocks=PARAM_GEN_A;
  uint32_t val1, val2, val3, val4, mask = (uint32_t)(1<<PARAM_Q_LOG)-1;
  unsigned char buf[SHAKE128_RATE*PARAM_GEN_A];
  uint16_t dmsp=0;

  cshake128_simple(buf, SHAKE128_RATE*PARAM_GEN_A, dmsp++, seed, CRYPTO_RANDOMBYTES);    
     
  while (i < PARAM_K*PARAM_N) {   
    if (pos > SHAKE128_RATE*nblocks - 4*nbytes) {
      nblocks = 1;
      cshake128_simple(buf, SHAKE128_RATE*nblocks, dmsp++, seed, CRYPTO_RANDOMBYTES);    
      pos = 0;
    } 
    val1  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val2  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val3  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    val4  = (*(uint32_t*)(buf+pos)) & mask;
    pos += nbytes;
    if (val1 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val1*PARAM_R2_INVN);
    if (val2 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val2*PARAM_R2_INVN);
    if (val3 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val3*PARAM_R2_INVN);
    if (val4 < PARAM_Q && i < PARAM_K*PARAM_N)
      a[i++] = reduce((int64_t)val4*PARAM_R2_INVN);
  }
}


int32_t reduce(int64_t a)
{ // Montgomery reduction
  int64_t u;

  u = (a*PARAM_QINV) & 0xFFFFFFFF;
  u *= PARAM_Q;
  a += u;
  return (int32_t)(a>>32);
}


int64_t barr_reduce64(int64_t a)
{ // Barrett reduction
  int64_t u = (a*PARAM_BARR_MULT)>>PARAM_BARR_DIV;
  return a - u*PARAM_Q;
}


sdigit_t barr_reduce(sdigit_t a)
{ // Barrett reduction
  digit_t u = ((int64_t)a*PARAM_BARR_MULT)>>PARAM_BARR_DIV;
  return a - (digit_t)u*PARAM_Q;
}


void dgt(poly x)
{
  int m, distance, jtwiddle;
  int j1, j2, j, k;
  int32_t temp_re, temp_img;

  distance = 512;
  jtwiddle = 0;
  for(m = 1; m < 256; m <<= 1)
  {
    // Even level
    for(k = 0; k < m; ++k)
    {
      j1 = (k * distance) << 1;
      j2 = j1 + distance - 1;
      for(j = j1; j <= j2; j += 2)
      {
        temp_re = reduce((int64_t)gj[jtwiddle] * x[j + distance] - 
                         (int64_t)gj[jtwiddle + 1] * x[j + distance + 1]); // Omit reduction (be lazy)
        temp_img = reduce((int64_t)gj[jtwiddle] * x[j + distance + 1] + 
                          (int64_t)gj[jtwiddle + 1] * x[j + distance]); // Omit reduction (be lazy)

        x[j + distance] = x[j] - temp_re; // Omit reduction (be lazy)
        x[j + distance + 1] = x[j + 1] - temp_img; // Omit reduction (be lazy)

        x[j] = x[j] + temp_re; // Omit reduction (be lazy)
        x[j + 1] = (x[j + 1] + temp_img); // Omit reduction (be lazy)
      }
      jtwiddle += 2;
    }
    distance >>= 1;
    m <<= 1;
    // Odd level
    for(k = 0; k < m; ++k)
    {
      j1 = (k * distance) << 1;
      j2 = j1 + distance - 1;
      for(j = j1; j <= j2; j += 2)
      {
        temp_re = reduce((int64_t)gj[jtwiddle] * x[j + distance]) - 
                  reduce((int64_t)gj[jtwiddle + 1] * x[j + distance + 1]);
        temp_re += (temp_re >> (RADIX32-1)) & PARAM_Q;

        temp_img = reduce((int64_t)gj[jtwiddle] * x[j + distance + 1]) + 
                   reduce((int64_t)gj[jtwiddle + 1] * x[j + distance]) - PARAM_Q;
        temp_img += (temp_img >> (RADIX32-1)) & PARAM_Q;

        x[j + distance] = x[j] - temp_re;
        x[j + distance] += (x[j + distance] >> (RADIX32-1)) & PARAM_Q;

        x[j + distance + 1] = x[j + 1] - temp_img;
        x[j + distance + 1] += (x[j + distance + 1] >> (RADIX32-1)) & PARAM_Q;
        
        x[j] = x[j] + temp_re - PARAM_Q;
        x[j] += (x[j] >> (RADIX32-1)) & PARAM_Q;

        x[j + 1] = (x[j + 1] + temp_img - PARAM_Q);
        x[j + 1] += (x[j + 1] >> (RADIX32-1)) & PARAM_Q;
      }
      jtwiddle += 2;
    }
    distance >>= 1;    
  }
  // Even level
  for(k = 0; k < m; ++k)
  {
    j1 = (k * distance) << 1;
    j2 = j1 + distance - 1;
    for(j = j1; j <= j2; j += 2)
    {
      temp_re = reduce((int64_t)gj[jtwiddle] * x[j + distance] - 
                        (int64_t)gj[jtwiddle + 1] * x[j + distance + 1]); // Omit reduction (be lazy)
      temp_img = reduce((int64_t)gj[jtwiddle] * x[j + distance + 1] + 
                        (int64_t)gj[jtwiddle + 1] * x[j + distance]); // Omit reduction (be lazy)

      x[j + distance] = x[j] - temp_re; // Omit reduction (be lazy)
      x[j + distance + 1] = x[j + 1] - temp_img; // Omit reduction (be lazy)

      x[j] = x[j] + temp_re; // Omit reduction (be lazy)
      x[j + 1] = (x[j + 1] + temp_img); // Omit reduction (be lazy)
    }
    jtwiddle += 2;
  }
}


void idgt(poly x)
{
  int distance, j1, jtwiddle, m, j, h;
  int32_t temp_re, temp_img, sum_re, sum_img;

  h = 0;
  distance = 2;
  for(m = 512; m > 2; m >>= 1)
  {
    // Even level
    for(j1 = 0; j1 < distance; j1 += 2)
    {
      jtwiddle = h;
      for(j = j1; j < PARAM_N; j += 2*distance)
      {
        temp_re = x[j];
        temp_img = x[j + 1];

        x[j] = temp_re + x[j + distance]; // Omit reduction (be lazy)
        x[j + 1] = temp_img + x[j + distance + 1]; // Omit reduction (be lazy)

        sum_re = temp_re - x[j + distance]; // Omit reduction (be lazy)
        sum_img = temp_img - x[j + distance + 1]; // Omit reduction (be lazy)

        x[j + distance] = reduce((int64_t)invgj[jtwiddle] * sum_re -
                                 (int64_t)invgj[jtwiddle + 1] * sum_img); // Omit reduction (be lazy)
        x[j + distance + 1] = reduce((int64_t)invgj[jtwiddle] * sum_img + 
                                     (int64_t)invgj[jtwiddle + 1] * sum_re); // Omit reduction (be lazy)

        jtwiddle += 2;
      }
    }
    h += m;
    distance <<= 1;
    m >>= 1;
    // Odd level
    for(j1 = 0; j1 < distance; j1 += 2)
    {
      jtwiddle = h;
      for(j = j1; j < PARAM_N; j += 2*distance)
      {
        temp_re = x[j];
        temp_img = x[j + 1];

        x[j] = barr_reduce(temp_re + x[j + distance]);
        x[j + 1] = barr_reduce(temp_img + x[j + distance + 1]);

        sum_re = temp_re - x[j + distance]; // Omit reduction (be lazy)
        sum_img = temp_img - x[j + distance + 1]; // Omit reduction (be lazy)

        x[j + distance] = barr_reduce(reduce((int64_t)invgj[jtwiddle] * sum_re - 
                                             (int64_t)invgj[jtwiddle + 1] * sum_img));
        x[j + distance + 1] = barr_reduce(reduce((int64_t)invgj[jtwiddle] * sum_img + 
                                                 (int64_t)invgj[jtwiddle + 1] * sum_re));

        jtwiddle += 2;
      }
    }
    h += m;
    distance <<= 1;    
  }
  // Even level
  for(j1 = 0; j1 < distance; j1 += 2)
  {
    jtwiddle = h;
    for(j = j1; j < PARAM_N; j += 2*distance)
    {
      temp_re = x[j];
      temp_img = x[j + 1];

      x[j] = barr_reduce(temp_re + x[j + distance]);
      x[j + 1] = barr_reduce(temp_img + x[j + distance + 1]);

      sum_re = temp_re - x[j + distance]; // Omit reduction (be lazy)
      sum_img = temp_img - x[j + distance + 1]; // Omit reduction (be lazy)

      x[j + distance] = barr_reduce(reduce((int64_t)invgj[jtwiddle] * sum_re - 
                                           (int64_t)invgj[jtwiddle + 1] * sum_img));
      x[j + distance + 1] = barr_reduce(reduce((int64_t)invgj[jtwiddle] * sum_img + 
                                               (int64_t)invgj[jtwiddle + 1] * sum_re));

      jtwiddle += 2;
    }
  }  
}


void poly_pointwise(poly result, const poly x, const poly y)
{ // Pointwise polynomial multiplication result = x.y
  
  int i;

  for(i = 0; i < PARAM_N; i+=2) {             
    result[i] = reduce((int64_t)x[i] * y[i] -
                       (int64_t)x[i+1] * y[i+1]);
    result[i+1] = reduce((int64_t)x[i] * y[i+1] + 
                         (int64_t)x[i+1] * y[i]);
  }  
}


void poly_dgt(poly x_dgt, const poly x)
{
  int i, j;
  j = 0;

  for(i = 0; i < PARAM_N; i += 2) {             
      x_dgt[i] = x[j];      
      x_dgt[i+1] = x[j+512];
      j++;
  } 

  dgt(x_dgt);
}


void poly_invdgt(poly result, const poly x)
{
  poly aux_mul;
  int i, j;

  for(i = 0; i < PARAM_N; ++i)
    aux_mul[i] = x[i];

  idgt(aux_mul);

  i = 0;
  for(j = 0; j < 512; j++) {
      result[j] = aux_mul[i];
      result[j+512] = aux_mul[i+1];
      i += 2;
  }
}


void poly_mul(poly result, const poly x, const poly y)
{

  poly aux_mul;
  int i, j;

  /* Calculating the point-wise multiplication of input signals */
  for(i = 0; i < PARAM_N; i+=2) {             
    aux_mul[i] = barr_reduce(reduce((int64_t)x[i] * y[i]) -
                 reduce((int64_t)x[i+1] * y[i+1]));

    aux_mul[i+1] = barr_reduce(reduce((int64_t)x[i] * y[i+1]) + 
                   reduce((int64_t)x[i+1] * y[i]));
  }

  /* Recovering the multiplication result in Z[x]/<x^n+1> */
  idgt(aux_mul);

  /* Writing the result from the Gaussian integer to the polynomial form */
  i = 0;
  for(j = 0; j < 512; j++) {
      result[j] = aux_mul[i];
      result[j+512] = aux_mul[i+1];
      i += 2;
  }
}


void poly_add(poly result, const poly x, const poly y)
{ // Polynomial addition result = x+y

    for(int i=0; i<PARAM_N; i++)
      result[i] = x[i] + y[i];
}


void poly_add_correct(poly result, const poly x, const poly y)
{ // Polynomial addition result = x+y with correction

    for (int i=0; i<PARAM_N; i++) {
      result[i] = x[i] + y[i];
      result[i] += (result[i] >> (RADIX32-1)) & PARAM_Q;    // If result[i] < 0 then add q
      result[i] -= PARAM_Q;
      result[i] += (result[i] >> (RADIX32-1)) & PARAM_Q;    // If result[i] >= q then subtract q
    }
}


void poly_sub(poly result, const poly x, const poly y)
{ // Polynomial subtraction result = x-y

    for (int i=0; i<PARAM_N; i++)
      result[i] = x[i] - y[i];
}    


void poly_sub_reduce(poly result, const poly x, const poly y)
{ // Polynomial subtraction result = x-y

    for (int i=0; i<PARAM_N; i++)
      result[i] = (int32_t)barr_reduce(x[i] - y[i]);
}


/********************************************************************************************
* Name:        sparse_mul8
* Description: performs sparse polynomial multiplication
* Parameters:  inputs:
*              - const unsigned char* s: part of the secret key
*              - const uint32_t pos_list[PARAM_H]: list of indices of nonzero elements in c
*              - const int16_t sign_list[PARAM_H]: list of signs of nonzero elements in c
*              outputs:
*              - poly prod: product of 2 polynomials
*
* Note: pos_list[] and sign_list[] contain public information since c is public
*********************************************************************************************/
void sparse_mul8(poly prod, const unsigned char *s, const uint32_t pos_list[PARAM_H], const int16_t sign_list[PARAM_H])
{
  int i, j, pos;
  int8_t *t = (int8_t*)s;

  for (i=0; i<PARAM_N; i++)
    prod[i] = 0;

  for (i=0; i<PARAM_H; i++) {
    pos = pos_list[i];
    for (j=0; j<pos; j++) {
        prod[j] = prod[j] - sign_list[i]*t[j+PARAM_N-pos];
    }
    for (j=pos; j<PARAM_N; j++) {
        prod[j] = prod[j] + sign_list[i]*t[j-pos];
    }
  }
}


/********************************************************************************************
* Name:        sparse_mul32
* Description: performs sparse polynomial multiplication 
* Parameters:  inputs:
*              - const int32_t* pk: part of the public key
*              - const uint32_t pos_list[PARAM_H]: list of indices of nonzero elements in c
*              - const int16_t sign_list[PARAM_H]: list of signs of nonzero elements in c
*              outputs:
*              - poly prod: product of 2 polynomials
*********************************************************************************************/
void sparse_mul32(poly prod, const int32_t *pk, const uint32_t pos_list[PARAM_H], const int16_t sign_list[PARAM_H])
{
  int i, j, pos;
  int64_t temp[PARAM_N] = {0};
  
  for (i=0; i<PARAM_H; i++) {
    pos = pos_list[i];
    for (j=0; j<pos; j++) {
        temp[j] = temp[j] - sign_list[i]*pk[j+PARAM_N-pos];
    }
    for (j=pos; j<PARAM_N; j++) {
        temp[j] = temp[j] + sign_list[i]*pk[j-pos];
    }
  }
  for (i=0; i<PARAM_N; i++)
    prod[i] = (int32_t)barr_reduce64(temp[i]);
}
