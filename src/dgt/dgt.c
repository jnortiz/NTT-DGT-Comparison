/*
 * gcc *.c *.h -o DGT -lm
*/
#include <stdio.h>
#include <stdlib.h>
#include <inttypes.h>
#include <math.h>

#include "gauss.h"

int64_t invkmodp[4] = {-72057594021150720u, -36028797010575360u, -18014398505287680u, -9007199252643840};
uint64_t gj[512] = {1, 13797081185216407910u, 17870292113338400769u, 281721071064741919u, 549755813888u, 14041890976876060974u, 1125917086449664u, 4299803665592489687u, 70368744161280u, 3051558327610197629u, 2198989700608u, 11387280211730213981u, 18446744069412487169u, 8668109077711679267u, 18446744065119551490u, 411429644661718300u, 17293822564807737345u, 15104850399680027611u, 18410715272395620481u, 16940035449150731648u, 8u, 18142929134658341675u, 13835128420805115905u, 2253768568517935352u, 4398046511104u, 1654663398520981866u, 9007336691597312u, 15951685255325333175u, 562949953290240u, 5965722551466996711u, 17591917604864u, 17311265416183374564u, 18446744069397807105u, 14004640413449681173u, 18446744035054321673u, 3291437157293746400u, 9223372032559808513u, 10158338780952714962u, 18158513693262873601u, 6393075107303762937u, 64u, 16016224591364643153u, 562949953421314u, 18030148548143482816u, 35184372088832u, 13237307188167854928u, 72058693532778496u, 16933017626115159474u, 4503599626321920u, 10832292272906805046u, 140735340838912u, 9362914843564906265u, 18446744069280366593u, 1356658891109943458u, 18446743794532483137u, 7884753188935386879u, 18446744052234715141u, 7479733969963382412u, 16140901060200898561u, 14251112719600934854u, 512u, 17449332314429639298u, 4503599627370512u, 15113979899245772281u, 281474976710656u, 13664737158269917819u, 576469548262227968u, 6336932523019185545u, 36028797010575360u, 12871361905596103084u, 1125882726711296u, 1116342470860912836u, 18446744068340842497u, 10853271128879547664u, 18446741870357774849u, 7737793303239342069u, 18446743931975630881u, 4497639551463306333u, 18446744065119682562u, 3328437340319972906u, 4096u, 10467450029535024137u, 36028797018964096u, 10231374777478672322u, 2251799813685248u, 17084176919086420947u, 4611756386097823744u, 13801972045324315718u, 288230376084602880u, 10737174897695903067u, 9007061813690368u, 8930739766887302688u, 18446744060824649729u, 13039192753378044028u, 18446726476960108545u, 6562114217670983589u, 18446742969902956801u, 17534372342291866343u, 18446744035055370249u, 8180754653145198927u, 32768u, 9952623958621855812u, 288230376151712768u, 8064021942171041292u, 18014398509481984u, 7546206866789277329u, 562949953421310u, 18182056015521604139u, 2305843008676823040u, 12110422903908887252u, 72056494509522944u, 16105685926854668541u, 18446744000695107585u, 12079821679951430619u, 18446603329778778113u, 15603425602538700070u, 18446735273321564161u, 11147770252432840497u, 18446743794540871745u, 10105805016917838453u, 262144u, 5834015391316509212u, 2305843009213702144u, 9171943329124577373u, 144115188075855872u, 5029422726070465669u, 4503599627370480u, 16329239638270742865u, 18446744069414584320u, 4649662884198176411u, 576451956076183552u, 18165022998349842402u, 18446743519658770433u, 4404853092538523347u, 18445618152328134657u, 14146940403822094634u, 18446673700670423041u, 15395185741804386692u, 18446741870424883713u, 7059463857684370340u, 2097152u, 9778634991702905054u, 4295032831u, 18035314424752866021u, 1152921504606846976u, 3341893669734556710u, 36028797018963840u, 1506708620263852673u, 18446744069414584313u, 303814934756242646u, 4611615648609468416u, 16192975500896648969u, 18446739671368073217u, 16792080670893602455u, 18437736732722987009u, 2495058814089251146u, 18446181119461294081u, 12481021517947587610u, 18446726477496979457u, 1135478653231209757u, 16777216u, 4442103655964903148u, 34360262648u, 15155306912120837921u, 9223372036854775808u, 8288405288461869359u, 288230376151710720u, 12053668962110821384u, 18446744069414584257u, 2430519478049941168u, 18446181119461163007u, 416595521271101505u, 18446708885042495489u, 5209436881246729393u, 18374685375881805825u, 1513726443299424847u, 18442240469788262401u, 7614451796507779275u, 18446603334073745409u, 9083829225849678056u, 134217728u, 17090085178304640863u, 274882101184u, 10561990880479197442u, 17179869180u, 10967010099451201909u, 2305843009213685760u, 4195631349813649467u, 18446744069414583809u, 997411754984945023u, 18442240469787213809u, 3332764170168812040u, 18446462594437873665u, 4782006911144666502u, 17870274521152356353u, 12109811546395398776u, 18410715272404008961u, 5575382163818481237u, 18445618186687873025u, 17330401598553671485u, 1073741824u, 7593472940535036657u, 2199056809472u, 10708950766175242252u, 137438953440u, 13949104517951277988u, 4294901759u, 15118306729094611415u, 18446744069414580225u, 7979294039879560184u, 18410715272395620225u, 8215369291935911999u, 18444492269600899073u, 1362567150328163374u, 13834987683316760577u, 4644772024090268603u, 18158513693329981441u, 7709569171718681254u, 18437737007600893953u, 9516004302527281633u, 8589934592u, 5407551316036540293u, 17592454475776u, 11884629851743600732u, 1099511627520u, 912371727122717978u, 34359214072u, 10265989416269385394u, 18446744069414551553u, 8494120110792728509u, 18158513693262871553u, 10382722127243543029u, 18428729670905102337u, 10900537202625306992u, 18446181119461163011u, 264688053892980182u, 16140901060737761281u, 6336321165505697069u, 18374687574905061377u, 2341058142559915780u, 68719476736u, 6366922389463153702u, 140739635806208u, 2843318466875884251u, 8796093020160u, 7298973816981743824u, 274873712576u, 8340939052496745868u, 18446744069414322177u, 12612728678098075109u, 16140901060200882177u, 9274800740290006948u, 18302628881338728449u, 13417321343344118652u, 18442240469787213841u, 2117504431143841456};
uint64_t invgj[512] = {1, 2117504431143841456u, 18442240469787213841u, 13417321343344118652u, 18302628881338728449u, 9274800740290006948u, 16140901060200882177u, 12612728678098075109u, 18446744069414322177u, 8340939052496745868u, 274873712576u, 7298973816981743824u, 8796093020160u, 2843318466875884251u, 140739635806208u, 6366922389463153702u, 68719476736u, 2341058142559915780u, 18374687574905061377u, 6336321165505697069u, 16140901060737761281u, 264688053892980182u, 18446181119461163011u, 10900537202625306992u, 18428729670905102337u, 10382722127243543029u, 18158513693262871553u, 8494120110792728509u, 18446744069414551553u, 10265989416269385394u, 34359214072u, 912371727122717978u, 1099511627520u, 11884629851743600732u, 17592454475776u, 5407551316036540293u, 8589934592u, 9516004302527281633u, 18437737007600893953u, 7709569171718681254u, 18158513693329981441u, 4644772024090268603u, 13834987683316760577u, 1362567150328163374u, 18444492269600899073u, 8215369291935911999u, 18410715272395620225u, 7979294039879560184u, 18446744069414580225u, 15118306729094611415u, 4294901759u, 13949104517951277988u, 137438953440u, 10708950766175242252u, 2199056809472u, 7593472940535036657u, 1073741824u, 17330401598553671485u, 18445618186687873025u, 5575382163818481237u, 18410715272404008961u, 12109811546395398776u, 17870274521152356353u, 4782006911144666502u, 18446462594437873665u, 3332764170168812040u, 18442240469787213809u, 997411754984945023u, 18446744069414583809u, 4195631349813649467u, 2305843009213685760u, 10967010099451201909u, 17179869180u, 10561990880479197442u, 274882101184u, 17090085178304640863u, 134217728u, 9083829225849678056u, 18446603334073745409u, 7614451796507779275u, 18442240469788262401u, 1513726443299424847u, 18374685375881805825u, 5209436881246729393u, 18446708885042495489u, 416595521271101505u, 18446181119461163007u, 2430519478049941168u, 18446744069414584257u, 12053668962110821384u, 288230376151710720u, 8288405288461869359u, 9223372036854775808u, 15155306912120837921u, 34360262648u, 4442103655964903148u, 16777216u, 1135478653231209757u, 18446726477496979457u, 12481021517947587610u, 18446181119461294081u, 2495058814089251146u, 18437736732722987009u, 16792080670893602455u, 18446739671368073217u, 16192975500896648969u, 4611615648609468416u, 303814934756242646u, 18446744069414584313u, 1506708620263852673u, 36028797018963840u, 3341893669734556710u, 1152921504606846976u, 18035314424752866021u, 4295032831u, 9778634991702905054u, 2097152u, 7059463857684370340u, 18446741870424883713u, 15395185741804386692u, 18446673700670423041u, 14146940403822094634u, 18445618152328134657u, 4404853092538523347u, 18446743519658770433u, 18165022998349842402u, 576451956076183552u, 4649662884198176411u, 18446744069414584320u, 16329239638270742865u, 4503599627370480u, 5029422726070465669u, 144115188075855872u, 9171943329124577373u, 2305843009213702144u, 5834015391316509212u, 262144u, 10105805016917838453u, 18446743794540871745u, 11147770252432840497u, 18446735273321564161u, 15603425602538700070u, 18446603329778778113u, 12079821679951430619u, 18446744000695107585u, 16105685926854668541u, 72056494509522944u, 12110422903908887252u, 2305843008676823040u, 18182056015521604139u, 562949953421310u, 7546206866789277329u, 18014398509481984u, 8064021942171041292u, 288230376151712768u, 9952623958621855812u, 32768u, 8180754653145198927u, 18446744035055370249u, 17534372342291866343u, 18446742969902956801u, 6562114217670983589u, 18446726476960108545u, 13039192753378044028u, 18446744060824649729u, 8930739766887302688u, 9007061813690368u, 10737174897695903067u, 288230376084602880u, 13801972045324315718u, 4611756386097823744u, 17084176919086420947u, 2251799813685248u, 10231374777478672322u, 36028797018964096u, 10467450029535024137u, 4096u, 3328437340319972906u, 18446744065119682562u, 4497639551463306333u, 18446743931975630881u, 7737793303239342069u, 18446741870357774849u, 10853271128879547664u, 18446744068340842497u, 1116342470860912836u, 1125882726711296u, 12871361905596103084u, 36028797010575360u, 6336932523019185545u, 576469548262227968u, 13664737158269917819u, 281474976710656u, 15113979899245772281u, 4503599627370512u, 17449332314429639298u, 512u, 14251112719600934854u, 16140901060200898561u, 7479733969963382412u, 18446744052234715141u, 7884753188935386879u, 18446743794532483137u, 1356658891109943458u, 18446744069280366593u, 9362914843564906265u, 140735340838912u, 10832292272906805046u, 4503599626321920u, 16933017626115159474u, 72058693532778496u, 13237307188167854928u, 35184372088832u, 18030148548143482816u, 562949953421314u, 16016224591364643153u, 64u, 6393075107303762937u, 18158513693262873601u, 10158338780952714962u, 9223372032559808513u, 3291437157293746400u, 18446744035054321673u, 14004640413449681173u, 18446744069397807105u, 17311265416183374564u, 17591917604864u, 5965722551466996711u, 562949953290240u, 15951685255325333175u, 9007336691597312u, 1654663398520981866u, 4398046511104u, 2253768568517935352u, 13835128420805115905u, 18142929134658341675u, 8u, 16940035449150731648u, 18410715272395620481u, 15104850399680027611u, 17293822564807737345u, 411429644661718300u, 18446744065119551490u, 8668109077711679267u, 18446744069412487169u, 11387280211730213981u, 2198989700608u, 3051558327610197629u, 70368744161280u, 4299803665592489687u, 1125917086449664u, 14041890976876060974u, 549755813888u, 281721071064741919u, 17870292113338400769u, 13797081185216407910u};

void print_signal(const gauss_t *_signal_a, const int length) {
    
    int i;

    printf("{(%" PRId64 ", i%" PRId64 "), ", _signal_a[0].re, _signal_a[0].img); 
    for(i = 1; i < length-1; i++) {
        printf("(%" PRId64 ", i%" PRId64 "), ", _signal_a[i].re, _signal_a[i].img); 
    }
    printf("(%" PRId64 ", i%" PRId64 ")}\n", _signal_a[length-1].re, _signal_a[length-1].img); 

}

int64_t get_invk_modp(const int dim) {

    int64_t inv;

    switch(dim) {
        case 256: inv = -72057594021150720; break;
        case 512: inv = -36028797010575360; break;
        case 1024: inv = -18014398505287680; break;
        case 2048: inv = -9007199252643840; break;
        default: inv = 0; break;
    }

    return inv;
}

/* dgt() receives as input a folded signal of n/2 Gaussian integers */
void dgt(gauss_t* _x, const gauss_t* _input_signal) {
    
    /* The input signal enters correct. */

    uint64_t power;
    int i, j, k, l, m, stride, upperbound;
    gauss_t xi, xim, aux_mul, aux_power;

    k = (int)(n/2);

    for(i = 0; i < k; i++) {
        _x[i].re = _input_signal[i].re;
        _x[i].img = _input_signal[i].img;
    }

    /* The copying process is OK. */

    upperbound = (int)(log(k)/log(2));
    
    for(stride = 0; stride < upperbound; stride++) {
        
        m = (int)(k/(2<<stride));
        
        for(l = 0; l < (int)(k/2); l++) {
            
            j = (int)((2*m*l)/k);
            power = mod_uint64_t((uint64_t)(pow(gj[j], k >> (upperbound-stride))));
            i = j + (l % (k/(2*m) )) * 2*m;

            xi.re = _x[i].re;
            xi.img = _x[i].img;

            xim.re = _x[i+m].re;
            xim.img = _x[i+m].img;

            set_gauss(&aux_power, (uint64_t)power, (uint64_t) 0);
            printf("%" PRIu64 "\n", power); 
            printf("(%" PRId64 ", i%" PRId64 ")\n", aux_power.re, aux_power.img); 

            add(&_x[i], xi, xim);
            mul(&aux_mul, xi, xim);
            mul(&_x[i+m], aux_power, aux_mul);

        }

    }
}

void idgt(gauss_t *_output_signal, const gauss_t *_x) {

    uint64_t power;
    int i, j, k, l, m, stride, upperbound;
    int64_t inv;
    gauss_t xi, xim, aux_inv, aux_mul, aux_power;

    k = (int)n/2;
    upperbound = (int)(log(k)/log(2));

    gauss_t _copy[k];

    for(i = 0; i < k; i++) {
        _copy[i].re = _x[i].re;
        _copy[i].img = _x[i].img;
    }

    m = 1;

    for(stride = 0; stride < upperbound; stride++) {

        for(l = 0; l < (int)(k/2); l++) {

            j = (int)(l/(k/(2*m)));
            power = mod_uint64_t((uint64_t)(pow(invgj[j], k >> (stride+1))));
            i = j + (l % ((int)(k/(2*m))))*2*m;

            xi = _copy[i];
            xim = _copy[i+m];

            set_gauss(&aux_power, (uint64_t)power, (uint64_t) 0);
            mul(&aux_mul, aux_power, xim);
            add(&_copy[i], xi, aux_mul);
            sub(&_copy[i+m], xi, aux_mul);

        }
        m = 2*m;
    }

    inv = get_invk_modp(k);

    aux_inv.re = inv;
    aux_inv.img = 0;

    for(i = 0; i < k; i++) {
        mul(&_output_signal[i], _copy[i], aux_inv);
    }

}

int test_dgt() {

    gauss_t _signal_a[n], _signal_b[n], _output[n];
    int i, is_equal;

    for(i = 0; i < n; i++) {
        _signal_a[i].re = (uint64_t) i;
        _signal_a[i].img = (uint64_t) 0;
    }

    //print_signal(_signal_a);

    dgt(_output, _signal_a);
    idgt(_signal_b, _output);

    //print_signal(_signal_b);

    is_equal = 1;

    for(i = 0; i < n && is_equal == 1; i++) {
        if(_signal_a[i].re != _signal_b[i].re || _signal_a[i].img != _signal_b[i].img) {
            printf("%" PRId64 ", i%" PRId64 "\n", _signal_a[i].re, _signal_a[i].img); 
            printf("%" PRId64 ", i%" PRId64 "\n", _signal_b[i].re, _signal_b[i].img); 
            printf("[!] The test has failed.\n");
            is_equal = 0;
        }
    }

    return is_equal;
}

int main(int argc, char** argv[]) {
    
    srand(time(NULL)); /* For generating random 128-bit vectors */

    printf("%" PRId64 "\n", n);
    printf("%d\n", test_dgt());

    return 0;
}