#include "dgt.h"
#include "params.h"
#include "reduce.h"

static uint32_t gj[K2] = {1, 3241972, 7044481, 7823561, 6250525, 2740543, 4795319, 4623627, 2883726, 394148, 4317364, 1858416, 7822959, 7220542, 2453983, 4805951, 4614810, 4018989, 4855975, 3192354, 601683, 5197539, 6096684, 6663429, 5178987, 7284949, 1674615, 2917338, 7375178, 3110818, 6666122, 3415069, 4808194, 2156050, 7703827, 4510100, 2682288, 4793971, 642628, 1935799, 5178923, 928749, 3370349, 5034454, 1221177, 3704823, 1460718, 817536, 4618904, 2071829, 7946292, 2897314, 4837932, 3602218, 2815639, 4430364, 3145678, 3506380, 2663378, 1853806, 4615550, 6279007, 5152541, 1759347, 8380416, 5138445, 1335936, 556856, 2129892, 5639874, 3585098, 3756790, 5496691, 7986269, 4063053, 6522001, 557458, 1159875, 5926434, 3574466, 3765607, 4361428, 3524442, 5188063, 7778734, 3182878, 2283733, 1716988, 3201430, 1095468, 6705802, 5463079, 1005239, 5269599, 1714295, 4965348, 3572223, 6224367, 676590, 3870317, 5698129, 3586446, 7737789, 6444618, 3201494, 7451668, 5010068, 3345963, 7159240, 4675594, 6919699, 7562881, 3761513, 6308588, 434125, 5483103, 3542485, 4778199, 5564778, 3950053, 5234739, 4874037, 5717039, 6526611, 3764867, 2101410, 3227876, 6621070};
static uint32_t invgj[K2] = {1, 6621070, 3227876, 2101410, 3764867, 6526611, 5717039, 4874037, 5234739, 3950053, 5564778, 4778199, 3542485, 5483103, 434125, 6308588, 3761513, 7562881, 6919699, 4675594, 7159240, 3345963, 5010068, 7451668, 3201494, 6444618, 7737789, 3586446, 5698129, 3870317, 676590, 6224367, 3572223, 4965348, 1714295, 5269599, 1005239, 5463079, 6705802, 1095468, 3201430, 1716988, 2283733, 3182878, 7778734, 5188063, 3524442, 4361428, 3765607, 3574466, 5926434, 1159875, 557458, 6522001, 4063053, 7986269, 5496691, 3756790, 3585098, 5639874, 2129892, 556856, 1335936, 5138445, 8380416, 1759347, 5152541, 6279007, 4615550, 1853806, 2663378, 3506380, 3145678, 4430364, 2815639, 3602218, 4837932, 2897314, 7946292, 2071829, 4618904, 817536, 1460718, 3704823, 1221177, 5034454, 3370349, 928749, 5178923, 1935799, 642628, 4793971, 2682288, 4510100, 7703827, 2156050, 4808194, 3415069, 6666122, 3110818, 7375178, 2917338, 1674615, 7284949, 5178987, 6663429, 6096684, 5197539, 601683, 3192354, 4855975, 4018989, 4614810, 4805951, 2453983, 7220542, 7822959, 1858416, 4317364, 394148, 2883726, 4623627, 4795319, 2740543, 6250525, 7823561, 7044481, 3241972};

void dgt(uint32_t p[N])
{

  int i, index, j, m, window;
  uint32_t a, sub_re, sub_img;

  window = 1;
  for(m = K2; m >= 2; m >>= 1) 
  {
    index = 0;
    for(j = 0; j < m; j += 2) 
    {
      a = gj[index];
      for(i = j; i < N; i += (m << 1)) 
      {
        sub_re = p[i] + (3*Q - p[i+m]);
        sub_img = p[i+1] + (3*Q - p[i+m+1]);
        
        p[i] = (p[i] + p[i+m]) % Q;
        p[i+1] = (p[i+1] + p[i+m+1]) % Q;
        
        p[i+m] = montgomery_reduce((uint64_t)a * sub_re);
        p[i+m+1] = montgomery_reduce((uint64_t)a * sub_img);        
      }
      index += window;
    }
    window <<= 1;
  }

}

void idgt(uint32_t p[N])
{

  int i, index, j, m, window;
  uint32_t a, mul_re, mul_img;

  window = (K2 >> 1);
  for(m = 2; m <= K2; m <<= 1) 
  {
    index = 0;
    for(j = 0; j < m; j += 2) 
    {
      a = invgj[index];
      for(i = j; i < N; i += (m << 1)) 
      {
        mul_re = montgomery_reduce((uint64_t)p[i+m] * a);
        mul_img = montgomery_reduce((uint64_t)p[i+m+1] * a);
        
        p[i+m] = (p[i] + (3*Q - mul_re)) % Q;
        p[i+m+1] = (p[i+1] + (3*Q - mul_img)) % Q;
        
        p[i] = (p[i] + mul_re) % Q;
        p[i+1] = (p[i+1] + mul_img) % Q;        
      }
      index += window;
    }
    window >>= 1;    
  }  

}