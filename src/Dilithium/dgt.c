#include <stdint.h>
#include "params.h"
#include "dgt.h"
#include "reduce.h"

static const uint32_t nthroots[N] = {4193792, 0, 257669, 3070091, 425600, 7918491, 5219093, 5526438, 1530397, 5427027, 7032257, 5455286, 585498, 6087160, 4253449, 5970952, 3851540, 1802675, 6223527, 199654, 5526349, 4671999, 3757153, 1591548, 4606183, 5792996, 6259025, 8152987, 3678505, 6425985, 2154104, 8342826, 2732474, 2253225, 2699464, 7809540, 1592430, 1457068, 6579413, 2898366, 5110559, 3518533, 5873283, 369461, 2325776, 4311190, 2715409, 4804802, 2198628, 4615245, 1913966, 3378506, 6153686, 3364814, 6450106, 4891026, 1615600, 5216309, 1080158, 6742704, 6398887, 8336461, 6540294, 449405, 114672, 49144, 794669, 6574010, 8228236, 7211335, 2036272, 2928171, 6991373, 139773, 1575249, 5742842, 1078237, 7410027, 2748567, 1456605, 250783, 7504823, 3422009, 1040941, 2401893, 1126796, 2804668, 7812539, 7681017, 2591893, 3028454, 2389700, 4234689, 1818645, 6102029, 7984287, 1622053, 7866503, 3684156, 2076821, 6973231, 3017475, 774841, 4240937, 62587, 3556595, 1579704, 7319279, 696682, 4931251, 8376364, 8178696, 4842267, 4832725, 2160571, 7744283, 3659093, 5681605, 5707905, 1671846, 3625039, 6990315, 5368161, 2830517, 3468953, 7234618, 2558711, 6462998, 3145216, 3145216, 318645, 7026116, 6595650, 1064431, 7776477, 5887749, 1755374, 3518445, 1599092, 1728671, 1378334, 7231633, 4046499, 3447598, 3818155, 822228, 3274624, 7757651, 5727714, 399609, 8133259, 3966345, 914719, 860233, 3192857, 2320724, 7548664, 1021874, 2876570, 8206939, 513914, 6758364, 6815261, 7781166, 532253, 7292158, 1108326, 348258, 7275426, 6212705, 3043186, 7141460, 359787, 1213445, 5405616, 7426305, 6011448, 2984143, 2275906, 6191420, 1757007, 8280392, 6878300, 1542114, 4115637, 6382167, 7265466, 6802044, 6103680, 2136573, 6369704, 2542034, 49144, 114672, 2837777, 7315730, 3252931, 2249330, 1213653, 5149417, 4787559, 7149865, 201635, 4327098, 3330969, 2871967, 4814859, 1298825, 1079044, 3215684, 5023919, 1004120, 3813872, 7687346, 6518471, 3001448, 578497, 2180517, 184386, 3669547, 1196038, 4918372, 2009694, 6054372, 6127192, 5647943, 5091281, 1473200, 1949710, 2757702, 3114687, 1286741, 4641742, 176926, 434609, 5572060, 5568852, 5685893, 2366380, 6181889, 2771640, 1783253, 1030324, 3007415, 8224351, 4677629, 7102028, 4838863, 8363219, 7588774, 7079145, 5099032, 1667385, 3799799, 2842329, 5379672};

/* Inverse of the powers of an k-th root of i times the Montgomery constant R = 2^32 mod p and the inverse of n/2 modulo p. */
static const uint32_t invnthroots[N] = {4193792, 0, 5379672, 5538088, 3799799, 6713032, 5099032, 1301272, 7588774, 17198, 4838863, 1278389, 4677629, 156066, 3007415, 7350093, 1783253, 5608777, 6181889, 6014037, 5685893, 2811565, 5572060, 7945808, 176926, 3738675, 1286741, 5265730, 2757702, 6430707, 1473200, 3289136, 5647943, 2253225, 6054372, 6370723, 4918372, 7184379, 3669547, 8196031, 2180517, 7801920, 3001448, 1861946, 7687346, 4566545, 1004120, 3356498, 3215684, 7301373, 1298825, 3565558, 2871967, 5049448, 4327098, 8178782, 7149865, 3592858, 5149417, 7166764, 2249330, 5127486, 7315730, 5542640, 114672, 8331273, 2542034, 2010713, 2136573, 2276737, 6802044, 1114951, 6382167, 4264780, 1542114, 1502117, 8280392, 6623410, 6191420, 6104511, 2984143, 2368969, 7426305, 2974801, 1213445, 8020630, 7141460, 5337231, 6212705, 1104991, 348258, 7272091, 7292158, 7848164, 7781166, 1565156, 6758364, 7866503, 8206939, 5503847, 1021874, 831753, 2320724, 5187560, 860233, 7465698, 3966345, 247158, 399609, 2652703, 7757651, 5105793, 822228, 4562262, 3447598, 4333918, 7231633, 7002083, 1728671, 6781325, 3518445, 6625043, 5887749, 603940, 1064431, 1784767, 7026116, 8061772, 3145216, 5235201, 6462998, 5821706, 7234618, 4911464, 2830517, 3012256, 6990315, 4755378, 1671846, 2672512, 5681605, 4721324, 7744283, 6219846, 4832725, 3538150, 8178696, 4053, 4931251, 7683735, 7319279, 6800713, 3556595, 8317830, 4240937, 7605576, 3017475, 1407186, 2076821, 4696261, 7866503, 6758364, 7984287, 2278388, 1818645, 4145728, 2389700, 5351963, 2591893, 699400, 7812539, 5575749, 1126796, 5978524, 1040941, 4958408, 7504823, 8129634, 1456605, 5631850, 7410027, 7302180, 5742842, 6805168, 139773, 1389044, 2928171, 6344145, 7211335, 152181, 6574010, 7585748, 49144, 8265745, 449405, 1840123, 8336461, 1981530, 6742704, 7300259, 5216309, 6764817, 4891026, 1930311, 3364814, 2226731, 3378506, 6466451, 4615245, 6181789, 4804802, 5665008, 4311190, 6054641, 369461, 2507134, 3518533, 3269858, 2898366, 1801004, 1457068, 6787987, 7809540, 5680953, 2253225, 5647943, 8342826, 6226313, 6425985, 4701912, 8152987, 2121392, 5792996, 3774234, 1591548, 4623264, 4671999, 2854068, 199654, 2156890, 1802675, 4528877, 5970952, 4126968, 6087160, 7794919, 5455286, 1348160, 5427027, 6850020, 5526438, 3161324, 7918491, 7954817, 3070091, 8122748};

/* Roots of unity in order needed by forward DGT */
static uint32_t gj[N/4] = {4193792, 25847, 2608894, 518909, 777960, 237124, 466468, 876248, 2091905, 8021166, 6554070, 6026966, 5268920, 5700314, 5495562, 5260684, 6271868, 5760665, 7830929, 7260833, 1024112, 5654953, 4794489, 7300517, 8360995, 6623180, 8100412, 4010497, 6980856, 5102745, 3859737, 6262231, 2348700, 7841118, 300467, 3539968, 4519302, 5336701, 4805995, 2867647, 3077325, 3530437, 8284641, 2706023, 4464978, 5842901, 1661693, 3592148, 7426187, 4499374, 531354, 7568473, 5582638, 6308525, 3900724, 5823537, 4873154, 2140649, 6779997, 3699596, 4558682, 4874723, 6681150, 6736599};

/* Roots of unity in order needed by inverse DGT */
static uint32_t invgj[N/4] = {4193792, 8354570, 7861508, 5771523, 7504169, 7913949, 8143293, 7602457, 3119733, 2884855, 2680103, 3111497, 2353451, 1826347, 359251, 6288512, 2118186, 4520680, 3277672, 1399561, 4369920, 280005, 1757237, 19422, 1079900, 3585928, 2725464, 7356305, 1119584, 549488, 2619752, 2108549, 1643818, 1699267, 3505694, 3821735, 4680821, 1600420, 6239768, 3507263, 2556880, 4479693, 2071892, 2797779, 811944, 7849063, 3881043, 954230, 4788269, 6718724, 2537516, 3915439, 5674394, 95776, 4849980, 5303092, 5512770, 3574422, 3043716, 3861115, 4840449, 8079950, 539299, 6031717};

/*************************************************
* Name:        dgt
*
* Description: Forward DGT, in-place. No modular reduction is performed after
*              additions or subtractions. If input coefficients are below 2*Q,
*              then output coefficients are below 18*Q.
*              Output vector is in bitreversed order.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void dgt(uint32_t p_ntt[N])
{
  int m, distance;
  int i, j1, j2, j, k;
  uint32_t a, a_re, a_img, b_re, b_img;
  uint32_t p[N];

  for(i = 0; i < N; ++i)
    p[i] = p_ntt[i];

  i = 0;
  for(j = 0; j < N/2; j = j+2)
  {
    a_re = 
      montgomery_reduce((uint64_t)p[i+N/4] * nthroots[j+N/2]) + 
      (2*Q - montgomery_reduce((uint64_t)p[i+N/2+N/4] * nthroots[j+N/2+1]))
    ;      
    a_img = 
      montgomery_reduce((uint64_t)p[i+N/4] * nthroots[j+N/2+1]) + 
      montgomery_reduce((uint64_t)p[i+N/2+N/4] * nthroots[j+N/2])
    ;

    b_re = 
      montgomery_reduce((uint64_t)p[i] * nthroots[j]) + 
      (2*Q - montgomery_reduce((uint64_t)p[i+N/2] * nthroots[j+1]))
    ;      
    b_img = 
      montgomery_reduce((uint64_t)p[i] * nthroots[j+1]) + 
      montgomery_reduce((uint64_t)p[i+N/2] * nthroots[j])
    ;
    i++;     

    p_ntt[j+N/2] = b_re + 2*Q - a_re;
    p_ntt[j+N/2+1] = b_img + 2*Q - a_img;
    
    p_ntt[j] = b_re + a_re;
    p_ntt[j+1] = b_img + a_img;
  }
  
  distance = N/4;
  for(m = 2; m < N/2; m <<= 1)
  {
    for(k = 0; k < m; ++k)
    {
      j1 = k*distance << 1;
      j2 = j1+distance-1;

      a = gj[k];
      for(j = j1; j <= j2; j = j+2)
      {
        a_re = montgomery_reduce((uint64_t)a*p_ntt[j+distance]);
        a_img = montgomery_reduce((uint64_t)a*p_ntt[j+distance+1]);

        p_ntt[j+distance] = p_ntt[j] + 2*Q - a_re;
        p_ntt[j+distance+1] = p_ntt[j+1] + 2*Q - a_img;
        
        p_ntt[j] = p_ntt[j] + a_re;
        p_ntt[j+1] = p_ntt[j+1] + a_img;
      }
    }
    distance >>= 1;
  }
}

/*************************************************
* Name:        invdgt_tomont
*
* Description: Inverse DGT and multiplication by Montgomery factor 2^32.
*              In-place. No modular reductions after additions or
*              subtractions. Input coefficient need to be smaller than 2*Q.
*              Output coefficient are smaller than 2*Q.
*
* Arguments:   - uint32_t p[N]: input/output coefficient array
**************************************************/
void invdgt_tomont(uint32_t x[N])
{
  int m, distance;
  int i, j1, j2, j, k;
  uint32_t a, a_re, a_img, sub_re, sub_img;
  uint32_t p[N];
  const uint32_t f = (((uint64_t)MONT*MONT % Q) * (Q-1) % Q) * ((Q-1) >> 7) % Q;
  
  m = N/4;
  for(distance = 2; distance < N/2; distance <<= 1)
  {
    for(k = 0; k < m; ++k)
    {
      j1 = 2 * k * distance;
      j2 = j1 + distance - 1;

      a = invgj[k];
      for(j = j1; j <= j2; j += 2)
      {
        sub_re = freeze(x[j] + 2*Q - x[j+distance]);
        sub_img = freeze(x[j+1] +  2*Q - x[j+distance+1]);
        
        x[j] = freeze(x[j] + x[j+distance]);
        x[j+1] = freeze(x[j+1] + x[j+distance+1]);

        x[j+distance] = montgomery_reduce((uint64_t)a * sub_re);
        x[j+distance+1] = montgomery_reduce((uint64_t)a * sub_img);
      }
    }
    m >>= 1;
  }

  for(j = 0; j < N; ++j)
    p[j] = x[j];

  i = 0;
  for(j = 0; j < N/2; j += 2)
  {
    sub_re = p[j] + 256*Q - p[j+N/2];
    sub_img = p[j+1] +  256*Q - p[j+N/2+1];
    
    a_re = p[j] + p[j+N/2];
    a_img = p[j+1] + p[j+N/2+1];

    x[i] = montgomery_reduce((uint64_t)a_re * invnthroots[j]) + 
          256*Q - montgomery_reduce((uint64_t)a_img * invnthroots[j+1]);

    x[i+N/2] = montgomery_reduce((uint64_t)a_re * invnthroots[j+1]) + 
              montgomery_reduce((uint64_t)a_img * invnthroots[j]);

    x[i+N/4] = montgomery_reduce((uint64_t)sub_re * invnthroots[j+N/2]) + 
              256*Q - montgomery_reduce((uint64_t)sub_img * invnthroots[j+N/2+1]);

    x[i+N/2+N/4] = montgomery_reduce((uint64_t)sub_re * invnthroots[j+N/2+1]) + 
              montgomery_reduce((uint64_t)sub_img * invnthroots[j+N/2]);

    i++;
  }  

  for(j = 0; j < N; ++j) {
    x[j] = montgomery_reduce((uint64_t)f * x[j]);
  }
}
