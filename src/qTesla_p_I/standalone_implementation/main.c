#include <stdlib.h>
#include <stdio.h>
#include <time.h>
#include <inttypes.h>

#include "poly.h"
#include "params.h"
#include "reduce.h"


#define N_RUNS 1


void random_polynomial(poly p);
int assert_equal(poly a, poly b);
void print_polynomial(poly p);
void test_multiplication();
void exact_reduction(poly p);


void random_polynomial(poly p) 
{
    int i;

    for(i = 0; i < PARAM_N; ++i)
    {
        p[i] = rand() % PARAM_Q;
    }
}


int assert_equal(poly a, poly b)
{
    int i;
    int are_equal;
    are_equal = 1u;

    for(i = 0; i < PARAM_N; ++i)
    {
        if(a[i] != b[i])
        {
            are_equal = 0u;
        }
    }

    return are_equal;
}


void exact_reduction(poly p)
{
    int i;

    for(i = 0; i < PARAM_N; ++i)
    {
        p[i] = p[i] % PARAM_Q;
    }    
}


void print_polynomial(poly p)
{
    int i;

    for(i = 0; i < PARAM_N-1; ++i)
    {
        printf("%" PRId32 ", ", p[i]);
    }    
    printf("%" PRId32 "\n\n", p[PARAM_N-1]);
}


void test_multiplication()
{
    printf("\nTesting polynomial multiplication via DGT\n");

    poly a, a_dgt, b, b_dgt, c;
    int32_t ab[PARAM_N] = {343575555, 343575557, 343575559, 343575561, 343575563, 343575565, 343575567, 343575569, 343575571, 343575573, 343575575, 343575577, 343575579, 343575581, 343575583, 343575585, 343575587, 343575589, 343575591, 343575593, 343575595, 343575597, 343575599, 343575601, 343575603, 343575605, 343575607, 343575609, 343575611, 343575613, 343575615, 343575617, 343575619, 343575621, 343575623, 343575625, 343575627, 343575629, 343575631, 343575633, 343575635, 343575637, 343575639, 343575641, 343575643, 343575645, 343575647, 343575649, 343575651, 343575653, 343575655, 343575657, 343575659, 343575661, 343575663, 343575665, 343575667, 343575669, 343575671, 343575673, 343575675, 343575677, 343575679, 343575681, 343575683, 343575685, 343575687, 343575689, 343575691, 343575693, 343575695, 343575697, 343575699, 343575701, 343575703, 343575705, 343575707, 343575709, 343575711, 343575713, 343575715, 343575717, 343575719, 343575721, 343575723, 343575725, 343575727, 343575729, 343575731, 343575733, 343575735, 343575737, 343575739, 343575741, 343575743, 343575745, 343575747, 343575749, 343575751, 343575753, 343575755, 343575757, 343575759, 343575761, 343575763, 343575765, 343575767, 343575769, 343575771, 343575773, 343575775, 343575777, 343575779, 343575781, 343575783, 343575785, 343575787, 343575789, 343575791, 343575793, 343575795, 343575797, 343575799, 343575801, 343575803, 343575805, 343575807, 343575809, 343575811, 343575813, 343575815, 343575817, 343575819, 343575821, 343575823, 343575825, 343575827, 343575829, 343575831, 343575833, 343575835, 343575837, 343575839, 343575841, 343575843, 343575845, 343575847, 343575849, 343575851, 343575853, 343575855, 343575857, 343575859, 343575861, 343575863, 343575865, 343575867, 343575869, 343575871, 343575873, 343575875, 343575877, 343575879, 343575881, 343575883, 343575885, 343575887, 343575889, 343575891, 343575893, 343575895, 343575897, 343575899, 343575901, 343575903, 343575905, 343575907, 343575909, 343575911, 343575913, 343575915, 343575917, 343575919, 343575921, 343575923, 343575925, 343575927, 343575929, 343575931, 343575933, 343575935, 343575937, 343575939, 343575941, 343575943, 343575945, 343575947, 343575949, 343575951, 343575953, 343575955, 343575957, 343575959, 343575961, 343575963, 343575965, 343575967, 343575969, 343575971, 343575973, 343575975, 343575977, 343575979, 343575981, 343575983, 343575985, 343575987, 343575989, 343575991, 343575993, 343575995, 343575997, 343575999, 343576001, 343576003, 343576005, 343576007, 343576009, 343576011, 343576013, 343576015, 343576017, 343576019, 343576021, 343576023, 343576025, 343576027, 343576029, 343576031, 343576033, 343576035, 343576037, 343576039, 343576041, 343576043, 343576045, 343576047, 343576049, 343576051, 343576053, 343576055, 343576057, 343576059, 343576061, 343576063, 343576065, 343576067, 343576069, 343576071, 343576073, 343576075, 343576077, 343576079, 343576081, 343576083, 343576085, 343576087, 343576089, 343576091, 343576093, 343576095, 343576097, 343576099, 343576101, 343576103, 343576105, 343576107, 343576109, 343576111, 343576113, 343576115, 343576117, 343576119, 343576121, 343576123, 343576125, 343576127, 343576129, 343576131, 343576133, 343576135, 343576137, 343576139, 343576141, 343576143, 343576145, 343576147, 343576149, 343576151, 343576153, 343576155, 343576157, 343576159, 343576161, 343576163, 343576165, 343576167, 343576169, 343576171, 343576173, 343576175, 343576177, 343576179, 343576181, 343576183, 343576185, 343576187, 343576189, 343576191, 343576193, 343576195, 343576197, 343576199, 343576201, 343576203, 343576205, 343576207, 343576209, 343576211, 343576213, 343576215, 343576217, 343576219, 343576221, 343576223, 343576225, 343576227, 343576229, 343576231, 343576233, 343576235, 343576237, 343576239, 343576241, 343576243, 343576245, 343576247, 343576249, 343576251, 343576253, 343576255, 343576257, 343576259, 343576261, 343576263, 343576265, 343576267, 343576269, 343576271, 343576273, 343576275, 343576277, 343576279, 343576281, 343576283, 343576285, 343576287, 343576289, 343576291, 343576293, 343576295, 343576297, 343576299, 343576301, 343576303, 343576305, 343576307, 343576309, 343576311, 343576313, 343576315, 343576317, 343576319, 343576321, 343576323, 343576325, 343576327, 343576329, 343576331, 343576333, 343576335, 343576337, 343576339, 343576341, 343576343, 343576345, 343576347, 343576349, 343576351, 343576353, 343576355, 343576357, 343576359, 343576361, 343576363, 343576365, 343576367, 343576369, 343576371, 343576373, 343576375, 343576377, 343576379, 343576381, 343576383, 343576385, 343576387, 343576389, 343576391, 343576393, 343576395, 343576397, 343576399, 343576401, 343576403, 343576405, 343576407, 343576409, 343576411, 343576413, 343576415, 343576417, 343576419, 343576421, 343576423, 343576425, 343576427, 343576429, 343576431, 343576433, 343576435, 343576437, 343576439, 343576441, 343576443, 343576445, 343576447, 343576449, 343576451, 343576453, 343576455, 343576457, 343576459, 343576461, 343576463, 343576465, 343576467, 343576469, 343576471, 343576473, 343576475, 343576477, 343576479, 343576481, 343576483, 343576485, 343576487, 343576489, 343576491, 343576493, 343576495, 343576497, 343576499, 343576501, 343576503, 343576505, 343576507, 343576509, 343576511, 343576513, 343576515, 343576517, 343576519, 343576521, 343576523, 343576525, 343576527, 343576529, 343576531, 343576533, 343576535, 343576537, 343576539, 343576541, 343576543, 343576545, 343576547, 343576549, 343576551, 343576553, 343576555, 343576557, 343576559, 343576561, 343576563, 343576565, 343576567, 343576569, 343576571, 343576573, 343576575, 0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54, 56, 58, 60, 62, 64, 66, 68, 70, 72, 74, 76, 78, 80, 82, 84, 86, 88, 90, 92, 94, 96, 98, 100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126, 128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 156, 158, 160, 162, 164, 166, 168, 170, 172, 174, 176, 178, 180, 182, 184, 186, 188, 190, 192, 194, 196, 198, 200, 202, 204, 206, 208, 210, 212, 214, 216, 218, 220, 222, 224, 226, 228, 230, 232, 234, 236, 238, 240, 242, 244, 246, 248, 250, 252, 254, 256, 258, 260, 262, 264, 266, 268, 270, 272, 274, 276, 278, 280, 282, 284, 286, 288, 290, 292, 294, 296, 298, 300, 302, 304, 306, 308, 310, 312, 314, 316, 318, 320, 322, 324, 326, 328, 330, 332, 334, 336, 338, 340, 342, 344, 346, 348, 350, 352, 354, 356, 358, 360, 362, 364, 366, 368, 370, 372, 374, 376, 378, 380, 382, 384, 386, 388, 390, 392, 394, 396, 398, 400, 402, 404, 406, 408, 410, 412, 414, 416, 418, 420, 422, 424, 426, 428, 430, 432, 434, 436, 438, 440, 442, 444, 446, 448, 450, 452, 454, 456, 458, 460, 462, 464, 466, 468, 470, 472, 474, 476, 478, 480, 482, 484, 486, 488, 490, 492, 494, 496, 498, 500, 502, 504, 506, 508, 510, 512, 514, 516, 518, 520, 522, 524, 526, 528, 530, 532, 534, 536, 538, 540, 542, 544, 546, 548, 550, 552, 554, 556, 558, 560, 562, 564, 566, 568, 570, 572, 574, 576, 578, 580, 582, 584, 586, 588, 590, 592, 594, 596, 598, 600, 602, 604, 606, 608, 610, 612, 614, 616, 618, 620, 622, 624, 626, 628, 630, 632, 634, 636, 638, 640, 642, 644, 646, 648, 650, 652, 654, 656, 658, 660, 662, 664, 666, 668, 670, 672, 674, 676, 678, 680, 682, 684, 686, 688, 690, 692, 694, 696, 698, 700, 702, 704, 706, 708, 710, 712, 714, 716, 718, 720, 722, 724, 726, 728, 730, 732, 734, 736, 738, 740, 742, 744, 746, 748, 750, 752, 754, 756, 758, 760, 762, 764, 766, 768, 770, 772, 774, 776, 778, 780, 782, 784, 786, 788, 790, 792, 794, 796, 798, 800, 802, 804, 806, 808, 810, 812, 814, 816, 818, 820, 822, 824, 826, 828, 830, 832, 834, 836, 838, 840, 842, 844, 846, 848, 850, 852, 854, 856, 858, 860, 862, 864, 866, 868, 870, 872, 874, 876, 878, 880, 882, 884, 886, 888, 890, 892, 894, 896, 898, 900, 902, 904, 906, 908, 910, 912, 914, 916, 918, 920, 922, 924, 926, 928, 930, 932, 934, 936, 938, 940, 942, 944, 946, 948, 950, 952, 954, 956, 958, 960, 962, 964, 966, 968, 970, 972, 974, 976, 978, 980, 982, 984, 986, 988, 990, 992, 994, 996, 998, 1000, 1002, 1004, 1006, 1008, 1010, 1012, 1014, 1016, 1018, 1020, 1022, 1024};
    int i;

    for(i = 0; i < PARAM_N; ++i)
    {
        a[i] = (int32_t) 1;
        b[i] = (int32_t) 1; // R^2 \times k^{-1} mod p
    }
    
    poly_dgt(a_dgt, a);
    poly_dgt(b_dgt, b);
    poly_mul(c, a_dgt, b_dgt);
    
    exact_reduction(c);    
    print_polynomial(c);

    int8_t is_OK = 1;
    for(i = 0; i < PARAM_N && is_OK == 1; ++i) 
    {
        if(c[i] != ab[i])
        {
            is_OK = 0;
        }
    }

    if(is_OK == 1u)
    {
        printf("\n> OK.\n");
    } else
    {
        printf("\n> Fail.\n");
    }    
}


int main(int argc, char *argv[]) 
{
    time_t t;    
    srand((unsigned) time(&t));    
    test_multiplication();
}